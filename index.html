<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Suite A33 ¬∑ Arcano 33</title>
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-a33-192.png">
  <link rel="apple-touch-icon" href="icon-a33-192.png">
  <style>
    :root{
      --bg:#000000;
      --bg-alt:#111111;
      --card:#1b1b1b;
      --primary:#7b1818;
      --primary-soft:#b28d38;
      --accent:#ddbf64;
      --text:#fefefe;
      --muted:#aaaaaa;
      --danger:#b00020;
      --radius:18px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      min-height:100vh;
      background:radial-gradient(circle at top,#1b1b1b 0,#000000 55%,#000000 100%);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1.5rem;
    }
    .shell{
      width:100%;
      max-width:960px;
      background:rgba(0,0,0,0.75);
      border-radius:24px;
      border:1px solid rgba(221,191,100,0.25);
      box-shadow:0 20px 40px rgba(0,0,0,0.7);
      padding:1.75rem 1.5rem 1.5rem;
      backdrop-filter:blur(10px);
    }
    header{
      display:flex;
      align-items:center;
      gap:1rem;
      margin-bottom:1rem;
    }
    header img{
      width:60px;
      height:60px;
      border-radius:999px;
      object-fit:contain;
      border:1px solid rgba(221,191,100,0.5);
      padding:4px;
      background:#000;
    }
    .title-block h1{
      font-family:"Cinzel",serif;
      font-size:1.4rem;
      letter-spacing:0.07em;
      text-transform:uppercase;
    }
    .title-block p{
      font-size:0.85rem;
      color:var(--muted);
    }
    main{
      margin-top:0.75rem;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1rem;
      margin-top:0.75rem;
    }
    .card{
      background:linear-gradient(135deg,rgba(27,27,27,0.95),rgba(16,16,16,0.98));
      border-radius:var(--radius);
      border:1px solid rgba(178,141,56,0.45);
      padding:1rem;
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition:transform 0.18s ease,box-shadow 0.18s ease,border-color 0.18s ease;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top,var(--primary) 0,transparent 55%);
      opacity:0;
      transition:opacity 0.25s ease;
      pointer-events:none;
    }
    .card:hover{
      transform:translateY(-3px);
      box-shadow:0 18px 35px rgba(0,0,0,0.85);
      border-color:var(--accent);
    }
    .card:hover::before{
      opacity:0.25;
    }
    .card h2{
      font-size:1.05rem;
      margin-bottom:0.4rem;
    }
    .card p{
      font-size:0.85rem;
      color:var(--muted);
      margin-bottom:0.6rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      padding:0.18rem 0.55rem;
      border-radius:999px;
      font-size:0.72rem;
      background:rgba(0,0,0,0.6);
      border:1px solid rgba(221,191,100,0.5);
      color:var(--accent);
    }
    .pill span{
      font-size:0.85rem;
    }
    .footer-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.75rem;
      color:var(--muted);
      margin-top:0.35rem;
    }
    .link-btn{
      border:none;
      border-radius:999px;
      padding:0.35rem 0.9rem;
      font-size:0.78rem;
      background:var(--primary);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
    }
    .link-btn span{
      font-size:0.9rem;
    }
    .link-btn.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,0.18);
      color:var(--text);
    }
    .lock-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#1b1b1b 0,#000 55%,#000 100%);
      z-index:20;
    }
    .lock-card{
      width:100%;
      max-width:380px;
      background:linear-gradient(145deg,#111111,#1c1414);
      border-radius:20px;
      padding:1.4rem 1.3rem 1.2rem;
      border:1px solid rgba(221,191,100,0.45);
      box-shadow:0 18px 40px rgba(0,0,0,0.9);
    }
    .lock-title{
      font-size:1.05rem;
      margin-bottom:0.35rem;
    }
    .lock-sub{
      font-size:0.8rem;
      color:var(--muted);
      margin-bottom:0.75rem;
    }
    .field{
      margin-bottom:0.6rem;
    }
    .field label{
      display:block;
      font-size:0.78rem;
      margin-bottom:0.22rem;
      color:var(--accent);
      letter-spacing:0.04em;
      text-transform:uppercase;
    }
    .field input[type="password"],
    .field input[type="text"]{
      width:100%;
      padding:0.45rem 0.65rem;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.16);
      background:#050505;
      color:var(--text);
      font-size:0.95rem;
      letter-spacing:0.02em;
      text-align:left;
    }
    .field input[type="password"]::placeholder{
      color:#444;
      letter-spacing:0.02em;
    }
    .btn-row{
      display:flex;
      gap:0.5rem;
      margin-top:0.4rem;
      align-items:center;
    }
    .btn{
      flex:1;
      border-radius:999px;
      border:none;
      padding:0.45rem 0.9rem;
      font-size:0.82rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.25rem;
    }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.18); color:var(--text); }
    .btn-danger{ background:transparent; border:1px solid rgba(176,0,32,0.8); color:#ff8a80; }

    /* --- Toast (mensajes r√°pidos) --- */
    .a33-toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%) translateY(0);
      background:rgba(8,8,8,0.92);
      border:1px solid rgba(221,191,100,0.35);
      color:var(--text);
      padding:0.55rem 0.85rem;
      border-radius:14px;
      font-size:0.82rem;
      z-index:9999;
      box-shadow:0 16px 40px rgba(0,0,0,0.65);
      max-width:min(560px, calc(100vw - 24px));
      opacity:0;
      pointer-events:none;
      transition:opacity 160ms ease, transform 160ms ease;
      text-align:center;
    }
    .a33-toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    .hint{
      font-size:0.72rem;
      color:var(--muted);
      margin-top:0.4rem;
    }
    .pin-mode-switch{
      text-align:right;
      margin-top:0.35rem;
      font-size:0.75rem;
    }
    .pin-mode-switch button{
      background:none;
      border:none;
      color:var(--accent);
      cursor:pointer;
      font-size:0.75rem;
      text-decoration:underline;
    }
    @media (max-width:600px){
      .shell{padding:1.25rem 1rem 1rem;}
      header img{width:52px;height:52px;}
      .grid{grid-template-columns:1fr;}
    }
  
    .menu-section{
      margin-top:1.25rem;
    }
    .menu-title{
      font-size:0.85rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
      margin:0 0 0.4rem;
    }


    /* --- N√öCLEO A33: fila fija 3 tiles (iPad) --- */
    .hidden{ display:none !important; }
    #support-grid{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    #support-grid .card{ min-width:0; }
    @media (max-width:720px){
      #support-grid{ grid-template-columns:1fr; }
    }


    /* --- Respaldo (Backup) --- */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.72);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1.25rem;
      z-index:50;
      backdrop-filter:blur(6px);
    }
    .modal-card{
      width:100%;
      max-width:720px;
      background:linear-gradient(145deg,#101010,#1c1414);
      border-radius:20px;
      padding:1.2rem 1.1rem 1.05rem;
      border:1px solid rgba(221,191,100,0.45);
      box-shadow:0 18px 40px rgba(0,0,0,0.9);
    }
    .modal-title{
      font-size:1.05rem;
      margin-bottom:0.35rem;
    }
    .modal-body{
      font-size:0.85rem;
      color:var(--text);
      line-height:1.35;
      max-height:60vh;
      overflow:auto;
      padding-right:0.2rem;
    }
    .modal-body .muted{ color:var(--muted); }
    .modal-body hr{ border:none;border-top:1px solid rgba(255,255,255,0.12); margin:0.7rem 0; }
    .modal-body ul{ margin:0.35rem 0 0.6rem 1.15rem; }
    .modal-body li{ margin:0.15rem 0; }
    .modal-actions{
      display:flex;
      gap:0.5rem;
      margin-top:0.8rem;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .badge-warn{
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      padding:0.18rem 0.55rem;
      border-radius:999px;
      border:1px solid rgba(176,0,32,0.75);
      color:#ff8a80;
      background:rgba(0,0,0,0.35);
      font-size:0.75rem;
      margin-top:0.35rem;
    }
    .kv{
      display:grid;
      grid-template-columns:150px 1fr;
      gap:0.25rem 0.75rem;
      margin-top:0.4rem;
    }
    .kv div{ padding:0.15rem 0; }
    .kv .k{ color:var(--accent); font-size:0.78rem; letter-spacing:0.02em; }
    .kv .v{ color:var(--text); font-size:0.85rem; word-break:break-word; }
    .small-note{ font-size:0.75rem; color:var(--muted); margin-top:0.4rem; }
    details summary{
      cursor:pointer;
      color:var(--accent);
      margin-top:0.35rem;
    }

    /* --- Boot splash (evita flashazo de login al volver al men√∫) --- */
    .boot-splash{
      position:fixed;
      inset:0;
      z-index:9998;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(900px 480px at 30% 20%, rgba(221,191,100,0.12), transparent 60%),
                 radial-gradient(700px 420px at 80% 0%, rgba(171,0,0,0.12), transparent 65%),
                 linear-gradient(145deg,#0b0b0b,#151010);
      color:#f2f2f2;
    }
    .boot-splash .boot-card{
      width:min(520px, 92vw);
      padding:1.15rem 1.15rem 1.0rem;
      border-radius:20px;
      border:1px solid rgba(221,191,100,0.45);
      box-shadow:0 18px 40px rgba(0,0,0,0.92);
      background:rgba(0,0,0,0.40);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align:left;
    }
    .boot-splash .boot-title{
      font-size:1.1rem;
      margin:0;
      letter-spacing:0.03em;
    }
    .boot-splash .boot-sub{
      margin:0.35rem 0 0;
      font-size:0.85rem;
      color:var(--muted);
      line-height:1.35;
    }
    .boot-splash .boot-dots{ display:inline-block; width:1.4em; text-align:left; }

</style>
</head>
<body>
  <!-- Splash inicial: evita el "flashazo" del login al volver al men√∫ principal -->
  <div class="boot-splash" id="boot-splash" aria-live="polite">
    <div class="boot-card">
      <h2 class="boot-title">Suite A33</h2>
      <p class="boot-sub">Verificando sesi√≥n<span class="boot-dots">‚Ä¶</span></p>
    </div>
  </div>

  <div class="lock-overlay" id="lock-overlay" style="display:none;">
    <div class="lock-card">
      <div id="lock-setup">
        <h2 class="lock-title">Configurar acceso</h2>
        <p class="lock-sub">Crea <b>usuario</b> y <b>contrase√±a</b> para proteger la Suite A33 en este dispositivo.</p>
        <div class="field">
          <label for="auth-user">Usuario</label>
          <input id="auth-user" type="text" autocomplete="username" placeholder="Ej: alquimista" />
        </div>
        <div class="field">
          <label for="auth-pass">Contrase√±a</label>
          <input id="auth-pass" type="password" autocomplete="new-password" placeholder="Tu contrase√±a" />
        </div>
        <div class="field">
          <label for="auth-pass2">Confirmar contrase√±a</label>
          <input id="auth-pass2" type="password" autocomplete="new-password" placeholder="Repite la contrase√±a" />
        </div>
        <div class="field">
          <label for="auth-name">Nombre (opcional)</label>
          <input id="auth-name" type="text" autocomplete="name" placeholder="Ej: El Alquimista" />
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" id="btn-auth-setup">Guardar acceso</button>
        </div>
        <p class="hint">Se guarda solo en este navegador (modo app/PWA). Si borras los datos, tendr√°s que configurarlo de nuevo.</p>
      </div>

      <div id="lock-unlock" style="display:none;">
        <h2 class="lock-title">Iniciar sesi√≥n</h2>
        <p class="lock-sub">Ingresa tus credenciales para acceder a los m√≥dulos.</p>
        <div class="field">
          <label for="login-user">Usuario</label>
          <input id="login-user" type="text" autocomplete="username" placeholder="Tu usuario" />
        </div>
        <div class="field">
          <label for="login-pass">Contrase√±a</label>
          <input id="login-pass" type="password" autocomplete="current-password" placeholder="Tu contrase√±a" />
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" id="btn-login">Entrar</button>
          <button class="btn btn-danger" id="btn-reset-credentials">Resetear acceso</button>
        </div>
        <p class="hint">La sesi√≥n vive en este navegador y expira (por defecto) en 12 horas.</p>
      </div>

      <div class="pin-mode-switch" id="pin-mode-switch" style="display:none;"></div>
    </div>
  </div>

  <div class="shell" id="app-shell" style="display:none;">
    <header>
      <img src="icon-a33-192.png" alt="Arcano 33">
      <div class="title-block">
        <h1>Suite A33 ¬∑ Arcano 33</h1>
        <p>Panel interno para producci√≥n, control de lotes y ventas.</p>
      </div>
    </header>

    <main>
      <div id="home-view">
      <p style="font-size:0.85rem;color:var(--muted);margin-bottom:0.35rem;">
        Selecciona un m√≥dulo para trabajar. Puedes fijar esta Suite en la pantalla de inicio de tu tel√©fono para acceder m√°s r√°pido.
      </p>

      <section class="menu-section">
        <h2 class="menu-title">Suite A33 Hecha por El Alquimista</h2>
        <div class="grid">
        <article class="card" data-link="calculadora/index.html">
          <div class="pill"><span>üß™</span><span>Producci√≥n</span></div>
          <h2>Calculadora de Producci√≥n</h2>
          <p>Define cu√°ntos Pulsos, Medias, Djebas, Litros y Galones har√°s y obt√©n la materia prima y volumen final.</p>
          <div class="footer-row">
            <span>Basado en recetas A33.</span>
            <button class="link-btn"><span>Ir</span> ‚Üí</button>
          </div>
        </article>

        <article class="card" data-link="lotes/index.html">
          <div class="pill"><span>üì¶</span><span>Lotes</span></div>
          <h2>Control de Lotes</h2>
          <p>Registra cada lote producido con fechas, vol√∫menes y presentaciones. Exporta CSV y consulta historial.</p>
          <div class="footer-row">
            <span>Seguimiento interno.</span>
            <button class="link-btn"><span>Ir</span> ‚Üí</button>
          </div>
        </article>
        <article class="card" data-link="inventario/index.html">
          <div class="pill"><span>üìä</span><span>Inventario</span></div>
          <h2>Inventario</h2>
          <p>Control de insumos l√≠quidos y botellas por presentaci√≥n, con alertas internas.</p>
          <div class="footer-row">
            <span>Se ajusta con la producci√≥n.</span>
            <button class="link-btn"><span>Ir</span> ‚Üí</button>
          </div>
        </article>

        <article class="card" data-link="pos/index.html">
          <div class="pill"><span>üßæ</span><span>Ventas</span></div>
          <h2>A33 POS ¬∑ Eventos</h2>
          <p>Registra ventas por evento, manejo de inventario y m√©todos de pago. Funciona offline.</p>
          <div class="footer-row">
            <span>Incluye descuentos por unidad.</span>
            <button class="link-btn"><span>Ir</span> ‚Üí</button>
          </div>
        </article>
        <article class="card" data-link="analitica/index.html">
          <div class="pill"><span>üìà</span><span>Anal√≠tica</span></div>
          <h2>Anal√≠tica de Ventas</h2>
          <p>Resumen mensual, comparativo por evento y por presentaci√≥n, en solo lectura desde el POS.</p>
          <div class="footer-row">
            <span>No modifica datos, solo analiza.</span>
            <button class="link-btn"><span>Ir</span> ‚Üí</button>
          </div>
        </article>
        <article class="card" data-link="pedidos/index.html">
          <div class="pill"><span>üìÖ</span><span>Pedidos</span></div>
          <h2>Planificaci√≥n de Pedidos</h2>
          <p>Registra pedidos de clientes, totales a pagar y marca cu√°ndo han sido entregados.</p>
          <div class="footer-row">
            <span>Enlace opcional a lotes.</span>
            <button class="link-btn"><span>Ir</span> ‚Üí</button>
          </div>
        </article>

      </div>
      </section>

      <section class="menu-section">
        <h2 class="menu-title">Finanzas</h2>
        <div class="grid">
          <article class="card" data-link="finanzas/index.html#tab=tablero">
            <div class="pill"><span>üí∞</span><span>Finanzas</span></div>
            <h2>Tablero Finanzas</h2>
            <p>Resumen mensual de ingresos, egresos, resultado y saldos de Caja y Banco.</p>
            <div class="footer-row">
              <span>Visi√≥n r√°pida del mes.</span>
              <button class="link-btn"><span>Ir</span> ‚Üí</button>
            </div>
          </article>

          <article class="card" data-link="finanzas/index.html#tab=diario">
            <div class="pill"><span>üìì</span><span>Diario</span></div>
            <h2>Diario y Ajustes</h2>
            <p>Registra ingresos, egresos y ajustes directos con doble partida.</p>
            <div class="footer-row">
              <span>Mini contabilidad.</span>
              <button class="link-btn"><span>Ir</span> ‚Üí</button>
            </div>
          </article>

          <article class="card" data-link="finanzas/index.html#tab=estados">
            <div class="pill"><span>üìë</span><span>Estados</span></div>
            <h2>Estados Financieros</h2>
            <p>Estado de Resultados y Balance General globales de Arcano 33.</p>
            <div class="footer-row">
              <span>Solo lectura desde Finanzas.</span>
              <button class="link-btn"><span>Ir</span> ‚Üí</button>
            </div>
          </article>
        </div>
      </section>

      
      <section class="menu-section">
        <h2 class="menu-title">N√öCLEO A33</h2>
        <div class="grid support-grid" id="support-grid">

          <article class="card" id="card-backup-hub">
            <div class="pill"><span>üóÑÔ∏è</span><span>Respaldo</span></div>
            <h2>Respaldo</h2>
            <p>Exporta o importa un JSON con todos los datos locales (IndexedDB + localStorage) de esta Suite.</p>
            <div class="footer-row">
              <span>Exportar / Importar</span>
              <button class="link-btn secondary"><span>Abrir</span> ‚Üí</button>
            </div>
          </article>

          <article class="card" id="card-user-panel">
            <div class="pill"><span>üë§</span><span>Usuario</span></div>
            <h2>Usuario</h2>
            <p>Nombre actual: <b id="user-card-name">‚Äî</b>. Cambia nombre o contrase√±a sin borrar datos.</p>
            <div class="footer-row">
              <span id="user-card-sub">Gestionar</span>
              <button class="link-btn secondary"><span>Abrir</span> ‚Üí</button>
            </div>
          </article>

          <article class="card" id="card-centro-mando" data-link="centro-mando/index.html">
            <div class="pill"><span>üß≠</span><span>Centro</span></div>
            <h2>Centro de Mando</h2>
            <p>Radar ligero por evento: Caja Chica, ventas, top productos e inventario cr√≠tico.</p>
            <div class="footer-row">
              <span>Evento enfocado + accesos r√°pidos.</span>
              <button class="link-btn secondary"><span>Abrir</span> ‚Üí</button>
            </div>
          </article>

          <!-- Elementos ocultos (reuso de handlers existentes) -->
          <button id="card-export-backup" class="hidden" type="button" aria-hidden="true"></button>
          <button id="card-import-backup" class="hidden" type="button" aria-hidden="true"></button>

        </div>
      </section>


      </div>

    </main>
  </div>


  <div class="modal-overlay" id="backup-modal" style="display:none;">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="backup-modal-title">
      <h2 class="modal-title" id="backup-modal-title">Respaldo</h2>
      <div class="modal-body" id="backup-modal-body"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="backup-modal-cancel">Cancelar</button>
        <button class="btn btn-ghost" id="backup-modal-secondary" style="display:none;">Secundario</button>
        <button class="btn btn-primary" id="backup-modal-primary">OK</button>
      </div>
    </div>
  </div>

  <input id="backup-file-input" type="file" accept="application/json" style="display:none;">
  <input id="calc-only-file-input" type="file" accept="application/json" style="display:none;">
  <div id="a33-toast" class="a33-toast" aria-live="polite"></div>


  <script src="assets/js/a33-storage.js"></script>
  <script src="assets/js/a33-auth.js"></script>
  <script>
    // --- Auth (usuario + contrase√±a, 1 usuario) ---
    const AUTH_DEFAULT_NAME = 'Usuario';

    function readAuth(){
      return {
        configured: A33Auth.isConfigured(),
        authenticated: A33Auth.isAuthenticated(),
        username: A33Auth.getUsername() || '',
        name: A33Auth.getDisplayName() || AUTH_DEFAULT_NAME
      };
    }

    function getStoredName(){
      return A33Auth.getDisplayName() || AUTH_DEFAULT_NAME;
    }

    function setStoredName(newName){
      A33Auth.setDisplayName((newName || '').trim() || AUTH_DEFAULT_NAME);
    }

    function hideBootSplash(){
      const bs = document.getElementById('boot-splash');
      if (bs) bs.style.display = 'none';
    }

    function showApp(){
      hideBootSplash();
      const overlay = document.getElementById('lock-overlay');
      const shell = document.getElementById('app-shell');
      overlay.style.display = 'none';
      shell.style.display = 'block';
    }

    function showLock(){
      hideBootSplash();
      const overlay = document.getElementById('lock-overlay');
      const shell = document.getElementById('app-shell');
      overlay.style.display = 'flex';
      shell.style.display = 'none';
    }

    async function initAuthUi(){
      await A33Auth.ensureMigrated();
      const overlay = document.getElementById('lock-overlay');
      const setup = document.getElementById('lock-setup');
      const unlock = document.getElementById('lock-unlock');
      const modeSwitch = document.getElementById('pin-mode-switch');

      const a = readAuth();
      if (a.configured && a.authenticated){
        overlay.style.display = 'none';
        showApp();
        if (modeSwitch) modeSwitch.style.display = 'none';
        return;
      }

      showLock();
      if (!a.configured){
        setup.style.display = 'block';
        unlock.style.display = 'none';
        if (modeSwitch) modeSwitch.style.display = 'none';
      } else {
        setup.style.display = 'none';
        unlock.style.display = 'block';
        if (modeSwitch) modeSwitch.style.display = 'none';
        const u = a.username;
        const uEl = document.getElementById('login-user');
        if (uEl && u) uEl.value = u;
      }
    }

    // --- Respaldo local (Exportar / Importar) ---
    const BACKUP_APP_NAME = 'Suite A33';
    const SUITE_LS_PREFIXES = ['arcano33_', 'a33_', 'suite_a33_']; 

    function isSuiteLocalStorageKey(key){
      if (!key) return false;
      return SUITE_LS_PREFIXES.some(p => key.startsWith(p));
    }

    function isSuiteDbName(name){
      if (!name) return false;
      if (name === 'finanzasDB') return true;
      const n = String(name).toLowerCase();
      return n.includes('a33') || n.includes('arcano') || n.includes('finanzas');
    }

    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function formatBytes(bytes){
      const b = Number(bytes || 0);
      if (!Number.isFinite(b) || b <= 0) return '0 B';
      const units = ['B','KB','MB','GB'];
      let v = b;
      let i = 0;
      while (v >= 1024 && i < units.length - 1){
        v = v / 1024;
        i++;
      }
      return `${v.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
    }

    function reqToPromise(req){
      return new Promise((resolve, reject) => {
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error || new Error('IndexedDB request error'));
      });
    }

    function txDone(tx){
      return new Promise((resolve, reject) => {
        tx.oncomplete = () => resolve(true);
        tx.onabort = () => reject(tx.error || new Error('Transacci√≥n abortada'));
        tx.onerror = () => reject(tx.error || new Error('Error en transacci√≥n'));
      });
    }

    async function safeListIndexedDBDatabases(){
      if (indexedDB.databases){
        try{
          const list = await indexedDB.databases();
          if (Array.isArray(list)) return list.filter(d => d && d.name);
        }catch(e){}
      }
      // Fallback (navegadores sin indexedDB.databases)
      return [
        { name: 'a33-pos' },
        { name: 'finanzasDB' }
      ];
    }

    function openExistingDB(dbName){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(dbName);
        // Si no existe, esto intentar√≠a crearlo: abortamos para NO mutar el navegador al solo "leer"
        req.onupgradeneeded = (e) => {
          try{ e.target.transaction.abort(); }catch(_){}
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error || new Error(`No se pudo abrir la base de datos: ${dbName}`));
      });
    }

    async function getAllFromStore(store){
      if (store.getAll){
        return await reqToPromise(store.getAll());
      }
      // Fallback cursor
      return await new Promise((resolve, reject) => {
        const out = [];
        const req = store.openCursor();
        req.onerror = () => reject(req.error || new Error('Error leyendo cursor'));
        req.onsuccess = (e) => {
          const cursor = e.target.result;
          if (cursor){
            out.push(cursor.value);
            cursor.continue();
          } else {
            resolve(out);
          }
        };
      });
    }

    async function snapshotDatabase(dbName){
      const db = await openExistingDB(dbName);
      const snapshot = {
        name: dbName,
        version: db.version,
        stores: {}
      };

      const storeNames = Array.from(db.objectStoreNames || []);
      for (const storeName of storeNames){
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);

        const schema = {
          keyPath: store.keyPath ?? null,
          autoIncrement: !!store.autoIncrement,
          indices: []
        };

        try{
          const indexNames = Array.from(store.indexNames || []);
          for (const idxName of indexNames){
            const idx = store.index(idxName);
            schema.indices.push({
              name: idxName,
              keyPath: idx.keyPath ?? null,
              unique: !!idx.unique,
              multiEntry: !!idx.multiEntry
            });
          }
        }catch(_){}

        const records = await getAllFromStore(store);
        await txDone(tx);

        snapshot.stores[storeName] = {
          count: Array.isArray(records) ? records.length : 0,
          schema,
          records: Array.isArray(records) ? records : []
        };
      }

      try{ db.close(); }catch(_){}
      return snapshot;
    }

    function getSuiteLocalStorageSnapshot(){
      const out = {};
      const keys = [];
      const allKeys = A33Storage.keys({ scope: 'local' });
      for (const k of allKeys){
        if (!k) continue;
        if (!isSuiteLocalStorageKey(k)) continue;
        keys.push(k);
        out[k] = A33Storage.getItem(k);
      }
      keys.sort();
      return { data: out, keys, count: keys.length };
    }

    function buildSummaryHtmlFromSnapshot({ dbSnapshots, lsKeys, exportedAt, estimatedBytes, warnings, appName }){
      const totalDbRecords = dbSnapshots.reduce((acc, d) => {
        const stores = Object.values(d.stores || {});
        return acc + stores.reduce((a, s) => a + (Number(s.count) || 0), 0);
      }, 0);

      const dbHtml = dbSnapshots.length
        ? dbSnapshots.map(d => {
            const stores = Object.entries(d.stores || {});
            const storeLines = stores.length
              ? `<ul>${stores.map(([sn, s]) => `<li><b>${escapeHtml(sn)}</b>: ${Number(s.count)||0}</li>`).join('')}</ul>`
              : `<div class="muted">Sin stores detectados.</div>`;
            return `
              <div style="margin-top:0.35rem;">
                <div><b>${escapeHtml(d.name)}</b> <span class="muted">(versi√≥n ${escapeHtml(d.version)})</span></div>
                ${storeLines}
              </div>
            `;
          }).join('')
        : `<div class="muted">No se detectaron bases de datos de la Suite en este navegador.</div>`;

      const warnHtml = (warnings && warnings.length)
        ? `<div class="badge-warn">‚ö†Ô∏è ${escapeHtml(warnings.join(' ¬∑ '))}</div>`
        : '';

      const lsDetails = lsKeys && lsKeys.length
        ? `<details><summary>Ver keys (${lsKeys.length})</summary><ul>${lsKeys.map(k => `<li>${escapeHtml(k)}</li>`).join('')}</ul></details>`
        : `<div class="muted">0 keys</div>`;

      const exportedAtPretty = exportedAt ? new Date(exportedAt).toLocaleString() : '';

      return `
        <div>
          <div class="kv">
            <div class="k">App</div><div class="v">${escapeHtml(appName || BACKUP_APP_NAME)}</div>
            <div class="k">Fecha</div><div class="v">${escapeHtml(exportedAtPretty)}</div>
            <div class="k">Registros</div><div class="v">${totalDbRecords}</div>
            <div class="k">Keys localStorage</div><div class="v">${lsKeys ? lsKeys.length : 0}</div>
            <div class="k">Tama√±o aprox.</div><div class="v">${escapeHtml(formatBytes(estimatedBytes || 0))}</div>
          </div>

          ${warnHtml}

          <hr>

          <div><b>IndexedDB</b></div>
          ${dbHtml}

          <hr>

          <div><b>localStorage (Suite)</b></div>
          ${lsDetails}

          <div class="small-note">Nota: este respaldo es local (no sincroniza). Al importar, se reemplaza TODO lo de este navegador.</div>
        </div>
      `;
    }

    function showModal({ title, bodyHtml, primaryText, onPrimary, secondaryText, onSecondary, cancelText, onCancel, disableCancel, disablePrimary }){
      const modal = document.getElementById('backup-modal');
      const titleEl = document.getElementById('backup-modal-title');
      const bodyEl = document.getElementById('backup-modal-body');
      const btnCancel = document.getElementById('backup-modal-cancel');
      const btnPrimary = document.getElementById('backup-modal-primary');
      const btnSecondary = document.getElementById('backup-modal-secondary');

      titleEl.textContent = title || 'Respaldo';
      bodyEl.innerHTML = bodyHtml || '';

      btnPrimary.textContent = primaryText || 'OK';
      btnPrimary.style.display = disablePrimary ? 'none' : 'inline-flex';
      btnPrimary.onclick = null;
      btnPrimary.onclick = async () => {
        if (typeof onPrimary === 'function') await onPrimary();
      };

      if (secondaryText && typeof onSecondary === 'function'){
        btnSecondary.style.display = 'inline-flex';
        btnSecondary.textContent = secondaryText;
        btnSecondary.onclick = null;
        btnSecondary.onclick = async () => {
          await onSecondary();
        };
      } else {
        btnSecondary.style.display = 'none';
        btnSecondary.onclick = null;
      }

      btnCancel.textContent = cancelText || 'Cancelar';
      btnCancel.style.display = disableCancel ? 'none' : 'inline-flex';
      btnCancel.onclick = null;
      btnCancel.onclick = () => {
        if (typeof onCancel === 'function') onCancel();
        hideModal();
      };

      modal.style.display = 'flex';
    }

    function hideModal(){
      const modal = document.getElementById('backup-modal');
      modal.style.display = 'none';
    }

    function downloadTextFile(filename, content){
      const blob = new Blob([content], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // --- Toast ---
    let __toastTimer = null;
    function showToast(message, ms=4000){
      const el = document.getElementById('a33-toast');
      if (!el) { try{ alert(message); }catch(_){ } return; }
      el.textContent = String(message || '');
      el.classList.add('show');
      if (__toastTimer) clearTimeout(__toastTimer);
      __toastTimer = setTimeout(() => {
        try{ el.classList.remove('show'); }catch(_){ }
      }, Math.max(1500, Number(ms) || 4000));
    }

    // --- Calculadora (ONLY) : export + reset blindado ---
    // Calculadora ONLY (estricto): NO incluye inventario.
    // Compat: backups viejos podr√≠an traer arcano33_inventario; lo aceptamos pero lo IGNORAMOS al restaurar.
    const CALC_ONLY_KEYS = [
      'arcano33_recetas_v1',
      'arcano33_lote_actual',
      'arcano33_fecha_produccion',
      'arcano33_notas_lote',
      'arcano33_lotes'
    ];
    const CALC_ONLY_LEGACY_IGNORED_KEYS = ['arcano33_inventario'];
    const CALC_ONLY_ALLOWED_KEYS = CALC_ONLY_KEYS.concat(CALC_ONLY_LEGACY_IGNORED_KEYS);

    function snapshotCalculatorLocalStorage(){
      const data = {};
      for (const k of CALC_ONLY_KEYS){
        const v = A33Storage.getItem(k);
        if (v != null) data[k] = String(v);
      }
      return data;
    }

    function buildCalcOnlyFilename(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      const stamp = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
      return `A33_Calculadora_ONLY_${stamp}.json`;
    }

    function buildCalculatorOnlyExport(){
      return {
        app: 'Suite A33',
        module: 'calculadora',
        exportedAt: new Date().toISOString(),
        schemaVersion: 1,
        data: {
          localStorage: snapshotCalculatorLocalStorage()
        }
      };
    }

    function validateCalculatorOnlyBackup(obj){
      if (!obj || typeof obj !== 'object') return { ok:false, reason:'Archivo inv√°lido (no es un objeto JSON).' };

      // metadata m√≠nima (estricta)
      const app = obj.app;
      const module = obj.module;
      if (app !== 'Suite A33') return { ok:false, reason:'Metadata inv√°lida: app debe ser "Suite A33".' };
      if (module !== 'calculadora') return { ok:false, reason:'Metadata inv√°lida: module debe ser "calculadora".' };

      const data = obj.data;
      if (!data || typeof data !== 'object') return { ok:false, reason:'Falta data.' };

      const ls = data.localStorage;
      if (!ls || typeof ls !== 'object') return { ok:false, reason:'Falta data.localStorage.' };

      // Debe contener solo claves permitidas (y al menos 1)
      const keys = Object.keys(ls);
      if (keys.length === 0) return { ok:false, reason:'data.localStorage est√° vac√≠o.' };

      for (const k of keys){
        if (!CALC_ONLY_ALLOWED_KEYS.includes(k)){
          return { ok:false, reason:`Clave no permitida en data.localStorage: ${k}` };
        }
        const v = ls[k];
        if (typeof v !== 'string'){
          return { ok:false, reason:`Valor inv√°lido para ${k}: se esperaba string.` };
        }
      }

      // Filtrar solo lo estrictamente permitido (sin inventario)
      const filtered = {};
      for (const k of CALC_ONLY_KEYS){
        if (typeof ls[k] === 'string') filtered[k] = ls[k];
      }
      return { ok:true, payload:{ app, module, exportedAt: obj.exportedAt, schemaVersion: obj.schemaVersion, localStorage: filtered } };
    }

    function normalizeJsonText(s){
      return String(s || '').replace(/^Ôªø/, '').trim();
    }

    function safeJsonParse(text){
      const t = normalizeJsonText(text);
      try{ return { ok:true, obj: JSON.parse(t) }; }catch(e){ return { ok:false, error:e }; }
    }

    function shallowEqualStringsObj(a,b){
      const ak = Object.keys(a||{}).sort();
      const bk = Object.keys(b||{}).sort();
      if (ak.length !== bk.length) return false;
      for (let i=0;i<ak.length;i++){
        if (ak[i] !== bk[i]) return false;
        if (String(a[ak[i]]) !== String(b[bk[i]])) return false;
      }
      return true;
    }

    async function deleteAllSuiteCaches(){
      if (!('caches' in window)) return;
      try{
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }catch(_){ }
    }

    function clearSuiteStorageExceptCalculator(keepCalculator){
      // localStorage: solo claves suite
      const suiteKeys = getSuiteLocalStorageKeysInThisBrowser();
      for (const k of suiteKeys){
        if (keepCalculator && CALC_ONLY_KEYS.includes(k)) continue;
        try{ A33Storage.removeItem(k); }catch(_){ }
      }

      // sessionStorage: solo claves suite
      try{
        const toRemove = A33Storage.keys({ scope:'session' }).filter(k => k && isSuiteLocalStorageKey(k));
        toRemove.forEach(k => { try{ A33Storage.removeItem(k, 'session'); }catch(_){ } });
      }catch(_){ }
    }

    function restoreCalculatorLocalStorage(lsObj){
      const entries = Object.entries(lsObj || {});
      for (const [k,v] of entries){
        if (!CALC_ONLY_KEYS.includes(k)) continue;
        try{ A33Storage.setItem(k, String(v)); }catch(_){ }
      }
    }

    async function resetSuitePreservingCalculator(validCalcPayload){
      // Anti-duplicado: si el respaldo coincide con lo actual, no borramos las claves de calculadora.
      const currentCalc = snapshotCalculatorLocalStorage();
      const incomingCalc = validCalcPayload?.localStorage || {};
      const keepCalculator = shallowEqualStringsObj(currentCalc, incomingCalc);

      // 1) IndexedDB (Suite)
      const all = await safeListIndexedDBDatabases();
      const suiteDbList = (Array.isArray(all) ? all : [])
        .filter(d => d && d.name && isSuiteDbName(d.name))
        .map(d => d.name);

      for (const dbName of suiteDbList){
        await deleteDatabase(dbName);
      }

      // 2) localStorage / sessionStorage
      clearSuiteStorageExceptCalculator(keepCalculator);

      // 3) caches (SW)
      await deleteAllSuiteCaches();

      // 4) Restaurar Calculadora (si no la mantuvimos)
      if (!keepCalculator){
        restoreCalculatorLocalStorage(incomingCalc);
      }

      return { kept: keepCalculator };
    }


    function buildBackupFilename(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      const stamp = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      return `suitea33-backup-${stamp}.json`;
    }

    async function buildFullBackup(){
      const all = await safeListIndexedDBDatabases();
      const suiteDbList = (Array.isArray(all) ? all : []).filter(d => d && d.name && isSuiteDbName(d.name));

      const dbSnapshots = [];
      const dataIndexedDB = {};
      const dbVersions = {};
      const dbSchemas = {};

      for (const d of suiteDbList){
        try{
          const snap = await snapshotDatabase(d.name);
          dbSnapshots.push(snap);

          dataIndexedDB[d.name] = {};
          dbSchemas[d.name] = {};
          dbVersions[d.name] = snap.version;

          for (const [storeName, s] of Object.entries(snap.stores || {})){
            dataIndexedDB[d.name][storeName] = s.records || [];
            dbSchemas[d.name][storeName] = s.schema || {};
          }
        }catch(e){
          console.warn('No se pudo leer DB', d.name, e);
        }
      }

      const lsSnap = getSuiteLocalStorageSnapshot();

      const backup = {
        meta: {
          appName: BACKUP_APP_NAME,
          exportedAt: new Date().toISOString(),
          dbVersions,
          dbSchemas
        },
        data: {
          indexedDB: dataIndexedDB,
          localStorage: lsSnap.data
        }
      };

      const jsonString = JSON.stringify(backup, null, 2);
      const estimatedBytes = new Blob([jsonString]).size;

      return {
        backup,
        jsonString,
        estimatedBytes,
        dbSnapshots,
        lsKeys: lsSnap.keys
      };
    }

    function validateBackupStructure(obj){
      if (!obj || typeof obj !== 'object') return { ok:false, reason:'Archivo inv√°lido (no es un objeto JSON).' };
      if (!obj.meta || typeof obj.meta !== 'object') return { ok:false, reason:'Falta meta.' };
      if (!obj.data || typeof obj.data !== 'object') return { ok:false, reason:'Falta data.' };
      if (obj.meta.appName !== BACKUP_APP_NAME) return { ok:false, reason:`appName inv√°lido: se esperaba "${BACKUP_APP_NAME}".` };
      if (!obj.data.indexedDB || typeof obj.data.indexedDB !== 'object') return { ok:false, reason:'Falta data.indexedDB.' };
      if (!obj.data.localStorage || typeof obj.data.localStorage !== 'object') return { ok:false, reason:'Falta data.localStorage.' };
      return { ok:true };
    }

    function summarizeBackupObject(obj){
      const dbSnapshots = [];
      const indexed = obj?.data?.indexedDB || {};
      const versions = obj?.meta?.dbVersions || {};
      const schemas = obj?.meta?.dbSchemas || {};

      for (const [dbName, stores] of Object.entries(indexed)){
        const snap = { name: dbName, version: versions?.[dbName] ?? '', stores: {} };
        if (stores && typeof stores === 'object'){
          for (const [storeName, records] of Object.entries(stores)){
            const arr = Array.isArray(records) ? records : [];
            snap.stores[storeName] = {
              count: arr.length,
              schema: (schemas?.[dbName]?.[storeName]) || {},
              records: [] // no duplicar aqu√≠
            };
          }
        }
        dbSnapshots.push(snap);
      }

      const lsKeys = Object.keys(obj?.data?.localStorage || {}).sort();
      let estimatedBytes = 0;
      try{
        estimatedBytes = new Blob([JSON.stringify(obj)]).size;
      }catch(_){}

      return { dbSnapshots, lsKeys, estimatedBytes, exportedAt: obj?.meta?.exportedAt, appName: obj?.meta?.appName };
    }

    async function buildDbVersionWarnings(backupObj){
      const warnings = [];
      const bVersions = backupObj?.meta?.dbVersions || {};
      const dbNames = Object.keys(backupObj?.data?.indexedDB || {});
      for (const dbName of dbNames){
        const b = bVersions?.[dbName];
        if (typeof b !== 'number') continue;
        try{
          const db = await openExistingDB(dbName);
          const c = db.version;
          try{ db.close(); }catch(_){}
          if (typeof c === 'number' && b !== c){
            warnings.push(`${dbName}: respaldo v${b} / este navegador v${c}`);
          }
        }catch(_){
          // Si no existe o no se puede abrir, no advertimos: se crear√° al importar.
        }
      }
      return warnings;
    }


    function getSuiteLocalStorageKeysInThisBrowser(){
      return A33Storage.keys({ scope: 'local' }).filter(k => k && isSuiteLocalStorageKey(k));
    }

    function deleteDatabase(dbName){
      return new Promise((resolve, reject) => {
        const req = indexedDB.deleteDatabase(dbName);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error || new Error(`No se pudo borrar la DB: ${dbName}`));
        req.onblocked = () => reject(new Error(`Bloqueado: cierra otras pesta√±as de la Suite y reintenta (DB: ${dbName}).`));
      });
    }

    function openDBForRestore(dbName, version, schemaByStore){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(dbName, Number(version) || 1);

        req.onupgradeneeded = (e) => {
          const db = e.target.result;

          const stores = schemaByStore && typeof schemaByStore === 'object'
            ? Object.entries(schemaByStore)
            : [];

          for (const [storeName, sch] of stores){
            if (db.objectStoreNames.contains(storeName)) continue;

            const keyPath = (sch && ('keyPath' in sch)) ? sch.keyPath : null;
            const autoIncrement = !!(sch && sch.autoIncrement);

            const opts = {};
            if (keyPath) opts.keyPath = keyPath;
            if (autoIncrement) opts.autoIncrement = true;

            let os;
            try{
              os = db.createObjectStore(storeName, opts);
            }catch(err){
              // fallback s√∫per defensivo
              os = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
            }

            try{
              const indices = Array.isArray(sch?.indices) ? sch.indices : [];
              for (const idx of indices){
                if (!idx?.name) continue;
                try{
                  os.createIndex(idx.name, idx.keyPath, { unique: !!idx.unique, multiEntry: !!idx.multiEntry });
                }catch(_){}
              }
            }catch(_){}
          }
        };

        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error || new Error(`No se pudo abrir la DB para restaurar: ${dbName}`));
      });
    }

    async function restoreDatabase(dbName, dbPayload, dbVersion, dbSchemas){
      const schemaByStore = dbSchemas?.[dbName] || {};
      const version = dbVersion?.[dbName] || 1;

      const schemaAvailable = schemaByStore && typeof schemaByStore === 'object' && Object.keys(schemaByStore).length > 0;

      // Si hay esquema: recreamos DB y stores con total seguridad.
      // Si NO hay esquema: intentamos importar sobre una DB ya existente (sin crear / sin cambiar versi√≥n).
      const db = schemaAvailable
        ? await openDBForRestore(dbName, version, schemaByStore)
        : await openExistingDB(dbName);

      // Insertar registros por store
      const stores = dbPayload && typeof dbPayload === 'object'
        ? Object.entries(dbPayload)
        : [];

      for (const [storeName, records] of stores){
        if (!db.objectStoreNames.contains(storeName)) continue;

        const arr = Array.isArray(records) ? records : [];
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);

        // limpiar store antes de insertar
        try{ store.clear(); }catch(_){}

        for (const rec of arr){
          try{ store.put(rec); }catch(_){}
        }
        await txDone(tx);
      }

      try{ db.close(); }catch(_){}
    } 
    async function performImport(obj){ 
      const dbPayload = obj?.data?.indexedDB || {};
      const dbVersions = obj?.meta?.dbVersions || {};
      const dbSchemas = obj?.meta?.dbSchemas || {};

      // DBs del archivo que pertenecen a la Suite
      const fileSuite = Object.keys(dbPayload || {}).filter(isSuiteDbName);

      // DBs con esquema disponible (podemos borrar y recrear sin miedo)
      const schemaSupported = new Set(
        fileSuite.filter((dbName) => {
          const sch = dbSchemas?.[dbName];
          return sch && typeof sch === 'object' && Object.keys(sch).length > 0;
        })
      );

      // 2) Detectar DBs actuales de la Suite y borrarlas (solo si hay esquema para recrear)
      const current = await safeListIndexedDBDatabases();
      const currentSuite = (Array.isArray(current) ? current : [])
        .filter(d => d?.name && isSuiteDbName(d.name))
        .map(d => d.name);

      const toDelete = Array.from(new Set([...currentSuite, ...fileSuite]))
        .filter(dbName => schemaSupported.has(dbName));

      for (const dbName of toDelete){
        try{
          await deleteDatabase(dbName);
        }catch(e){
          // Si no exist√≠a, ok; si est√° bloqueado, es cr√≠tico
          if (String(e?.message || '').toLowerCase().includes('bloqueado')){
            throw e;
          }
        }
      }

      // 3) Restaurar DBs desde el archivo (con o sin esquema)
      for (const dbName of fileSuite){
        await restoreDatabase(dbName, dbPayload[dbName], dbVersions, dbSchemas);
      }

      // 4) Restaurar localStorage (solo keys Suite)
      const currentLsKeys = getSuiteLocalStorageKeysInThisBrowser();
      for (const k of currentLsKeys){
        try{ A33Storage.removeItem(k); }catch(_){}
      }

      const incoming = obj?.data?.localStorage || {};
      for (const [k, v] of Object.entries(incoming)){
        if (!isSuiteLocalStorageKey(k)) continue;
        try{ A33Storage.setItem(k, String(v ?? '')); }catch(_){}
      }

      return true;
    }


    document.addEventListener('DOMContentLoaded', () => {

      // Navegaci√≥n: tarjetas del men√∫ principal
      document.querySelectorAll('[data-link]').forEach(card => {
        card.addEventListener('click', () => {
          const href = card.getAttribute('data-link');
          if (href) window.location.href = href;
        });
      });


      // --- Auth UI (Setup + Login) ---
      const btnAuthSetup = document.getElementById('btn-auth-setup');
      const btnLogin = document.getElementById('btn-login');
      const btnResetCred = document.getElementById('btn-reset-credentials');

      async function safeRun(btn, fn){
        if (btn){ btn.disabled = true; btn.classList.add('is-loading'); }
        try{ await fn(); }
        finally{
          if (btn){ btn.disabled = false; btn.classList.remove('is-loading'); }
        }
      }

      async function doSetup(){
        const u = (document.getElementById('auth-user')?.value || '').trim();
        const p1 = String(document.getElementById('auth-pass')?.value || '');
        const p2 = String(document.getElementById('auth-pass2')?.value || '');
        const name = (document.getElementById('auth-name')?.value || '').trim();

        if (!u){ alert('Usuario requerido.'); return; }
        if (p1.length < 4){ alert('Contrase√±a muy corta (m√≠nimo 4).'); return; }
        if (p1 !== p2){ alert('Las contrase√±as no coinciden.'); return; }

        await A33Auth.setup({ username: u, password: p1, displayName: name || AUTH_DEFAULT_NAME });
        // Iniciar sesi√≥n de inmediato para evitar doble paso
        await A33Auth.login({ username: u, password: p1 });

        // Limpieza y refresco UI
        const pEl = document.getElementById('auth-pass'); if (pEl) pEl.value = '';
        const p2El = document.getElementById('auth-pass2'); if (p2El) p2El.value = '';
        await initAuthUi();
      }

      async function doLogin(){
        const u = (document.getElementById('login-user')?.value || '').trim();
        const p = String(document.getElementById('login-pass')?.value || '');

        if (!u){ alert('Usuario requerido.'); return; }
        if (!p){ alert('Contrase√±a requerida.'); return; }

        await A33Auth.login({ username: u, password: p });
        const pEl = document.getElementById('login-pass'); if (pEl) pEl.value = '';
        await initAuthUi();
      }

      if (btnAuthSetup){
        btnAuthSetup.addEventListener('click', () => safeRun(btnAuthSetup, async () => {
          try{ await doSetup(); }
          catch(e){ alert(e?.message || 'No se pudo configurar el acceso.'); }
        }));
      }

      if (btnLogin){
        btnLogin.addEventListener('click', () => safeRun(btnLogin, async () => {
          try{ await doLogin(); }
          catch(e){ alert(e?.message || 'Credenciales incorrectas.'); }
        }));
      }

      if (btnResetCred){
        btnResetCred.addEventListener('click', () => {
          const ok = confirm('¬øResetear acceso? Esto eliminar√° usuario/contrase√±a de este dispositivo.');
          if (!ok) return;
          try{ A33Auth.resetCredentials(); }catch(_){}
          initAuthUi();
        });
      }

      // Enter-to-submit (iPad friendly)
      const authPass2 = document.getElementById('auth-pass2');
      if (authPass2){
        authPass2.addEventListener('keydown', (e) => {
          if (e.key === 'Enter'){ e.preventDefault(); btnAuthSetup?.click(); }
        });
      }
      const loginPass = document.getElementById('login-pass');
      if (loginPass){
        loginPass.addEventListener('keydown', (e) => {
          if (e.key === 'Enter'){ e.preventDefault(); btnLogin?.click(); }
        });
      }

      // iPad PWA (Keychain/huella): auto-ingresar cuando iOS autocompleta usuario+contrase√±a.
      // Nota: iOS a veces NO dispara input/change al autocompletar; usamos triggers + polling corto.
      (function setupAutoLoginWithAutofill(){
        const unlockEl = document.getElementById('lock-unlock');
        const userEl = document.getElementById('login-user');
        const passEl = document.getElementById('login-pass');
        if (!unlockEl || !userEl || !passEl || !btnLogin) return;

        let lastAttemptSig = null; // firma en memoria (no persistente); evita reintentos infinitos.
        let pollId = null;
        let pollTimeoutId = null;

        function isUnlockVisible(){
          // unlockEl vive dentro de lock-overlay; initAuthUi lo alterna con style.display.
          return unlockEl.style.display !== 'none' && unlockEl.offsetParent !== null;
        }

        function getSig(){
          const u = (userEl.value || '').trim();
          const p = String(passEl.value || '');
          if (!u || !p) return null;
          // Evitamos guardar contrase√±a: solo longitud (suficiente para evitar loops).
          return `${u}::${p.length}`;
        }

        function stopPoll(){
          if (pollId){ clearInterval(pollId); pollId = null; }
          if (pollTimeoutId){ clearTimeout(pollTimeoutId); pollTimeoutId = null; }
        }

        function startPoll(){
          if (pollId) return;
          const startedAt = Date.now();
          pollId = setInterval(() => {
            // M√°x 3s para evitar loops/consumo.
            if (Date.now() - startedAt > 3000){ stopPoll(); return; }
            maybeAutoLogin('poll');
          }, 200);
          pollTimeoutId = setTimeout(stopPoll, 3200);
        }

        function maybeAutoLogin(source){
          try{
            if (!isUnlockVisible()) return;
            if (btnLogin.disabled) return;
            const sig = getSig();
            if (!sig) return;
            if (sig === lastAttemptSig) return;
            lastAttemptSig = sig;

            // iOS puede tardar un instante en ‚Äúasentar‚Äù el autocompletado.
            setTimeout(() => {
              if (!isUnlockVisible()) return;
              if (btnLogin.disabled) return;
              const sig2 = getSig();
              if (!sig2 || sig2 !== sig) return;
              btnLogin.click(); // reutiliza el mismo flujo (safeRun + doLogin)
            }, 350);
          }catch(_){
            // silencio: esto nunca debe romper el login.
          }
        }

        function onFieldActivity(){
          // Si el usuario borra/cambia, permitir un nuevo intento cuando vuelva a estar completo.
          if (!getSig()) lastAttemptSig = null;
          maybeAutoLogin('field');
        }

        // Triggers: focus (cuando el usuario toca y aparece Keychain), y eventos est√°ndar.
        userEl.addEventListener('focus', () => { startPoll(); setTimeout(() => maybeAutoLogin('focus-u'), 0); });
        passEl.addEventListener('focus', () => { startPoll(); setTimeout(() => maybeAutoLogin('focus-p'), 0); });
        userEl.addEventListener('input', onFieldActivity);
        passEl.addEventListener('input', onFieldActivity);
        userEl.addEventListener('change', onFieldActivity);
        passEl.addEventListener('change', onFieldActivity);
        userEl.addEventListener('blur', () => setTimeout(() => maybeAutoLogin('blur-u'), 0));
        passEl.addEventListener('blur', () => setTimeout(() => maybeAutoLogin('blur-p'), 0));

        // Al volver desde background o al mostrar la p√°gina, iOS a veces rellena tarde.
        window.addEventListener('pageshow', () => {
          setTimeout(() => { if (isUnlockVisible()) startPoll(); maybeAutoLogin('pageshow'); }, 250);
        });

        // Arranque suave: si ya hay credenciales (por username prefill + Keychain r√°pido).
        setTimeout(() => { if (isUnlockVisible()) startPoll(); maybeAutoLogin('boot'); }, 600);

      })();



      // --- Respaldo: Exportar / Importar ---
      const exportCard = document.getElementById('card-export-backup');
      const importCard = document.getElementById('card-import-backup');
      const fileInput = document.getElementById('backup-file-input');

      // Card: Respaldo (hub)
      const backupHubCard = document.getElementById('card-backup-hub');
      if (backupHubCard){
        backupHubCard.addEventListener('click', () => {
          showModal({
            title: 'Respaldo',
            bodyHtml: `
              <div>Eleg√≠ una acci√≥n. Esto trabaja <b>solo en este dispositivo</b> (no hay sync).</div>
              <div class="small-note">Tip: export√° antes de importar, por si acaso.</div>
            `,
            primaryText: 'Exportar',
            onPrimary: () => {
              hideModal();
              if (exportCard) exportCard.click();
            },
            secondaryText: 'Importar',
            onSecondary: () => {
              hideModal();
              if (importCard) importCard.click();
            },
            cancelText: 'Cerrar',
            onCancel: hideModal
          });

        });
      }

      // Card: Usuario (panel)
      const userPanelCard = document.getElementById('card-user-panel');
      const userCardNameEl = document.getElementById('user-card-name');
      const userCardSubEl = document.getElementById('user-card-sub');

      function refreshUserCard(){
        const a = readAuth();
        const name = a.name || AUTH_DEFAULT_NAME;
        if (userCardNameEl) userCardNameEl.textContent = name;
        if (userCardSubEl){
          if (!a.configured) userCardSubEl.textContent = 'Sin acceso';
          else userCardSubEl.textContent = a.authenticated ? 'Sesi√≥n activa' : 'Sesi√≥n expirada';
        }
      }

      function openChangeName(){
        const current = getStoredName();
        showModal({
          title: 'Cambiar nombre',
          bodyHtml: `
            <div class="field">
              <label for="user-name-input">Nombre</label>
              <input id="user-name-input" type="text" maxlength="40" value="${escapeHtml(current)}" placeholder="Ej. El Alquimista">
            </div>
            <div class="small-note">Se guarda solo en este navegador. No afecta datos de m√≥dulos.</div>
          `,
          primaryText: 'Guardar',
          onPrimary: () => {
            const el = document.getElementById('user-name-input');
            const v = (el && el.value ? el.value.trim() : '');
            if (!v){
              alert('Escribe un nombre.');
              return;
            }
            setStoredName(v);
            refreshUserCard();
            hideModal();
            alert('Nombre actualizado.');
          },
          cancelText: 'Cancelar',
          onCancel: hideModal
        });
        setTimeout(() => {
          const el = document.getElementById('user-name-input');
          if (el){ el.focus(); el.select(); }
        }, 0);
      }

      function openChangePassword(){
        const a = readAuth();
        if (!a.configured){
          alert('No hay acceso configurado todav√≠a.');
          return;
        }

        showModal({
          title: 'Cambiar contrase√±a',
          bodyHtml: `
            <div class="field">
              <label for="pw-current">Contrase√±a actual</label>
              <input id="pw-current" type="password" autocomplete="current-password" placeholder="Actual">
            </div>
            <div class="field">
              <label for="pw-new">Nueva contrase√±a</label>
              <input id="pw-new" type="password" autocomplete="new-password" placeholder="Nueva">
            </div>
            <div class="field">
              <label for="pw-new2">Confirmar nueva contrase√±a</label>
              <input id="pw-new2" type="password" autocomplete="new-password" placeholder="Repite">
            </div>
            <div class="small-note">Por seguridad se cerrar√° la sesi√≥n y tendr√°s que iniciar de nuevo.</div>
          `,
          primaryText: 'Guardar',
          onPrimary: async () => {
            const cur = (document.getElementById('pw-current')?.value || '');
            const p1 = (document.getElementById('pw-new')?.value || '');
            const p2 = (document.getElementById('pw-new2')?.value || '');
            if (!cur){ alert('Escribe la contrase√±a actual.'); return; }
            if (!p1 || p1.length < 4){ alert('Nueva contrase√±a muy corta (m√≠nimo 4).'); return; }
            if (p1 !== p2){ alert('Las contrase√±as no coinciden.'); return; }
            try{
              await A33Auth.changePassword({ username: A33Auth.getUsername(), currentPassword: cur, newPassword: p1 });
              hideModal();
              alert('Contrase√±a actualizada. Inicia sesi√≥n de nuevo.');
              await initAuthUi();
            }catch(e){
              alert(e?.message || 'No se pudo cambiar la contrase√±a.');
            }
          },
          cancelText: 'Cancelar',
          onCancel: hideModal
        });

        setTimeout(() => {
          const el = document.getElementById('pw-current');
          if (el){ el.focus(); }
        }, 0);
      }

      function openChangeUsername(){
        const a = readAuth();
        if (!a.configured){
          alert('No hay acceso configurado todav√≠a.');
          return;
        }
        showModal({
          title: 'Cambiar usuario',
          bodyHtml: `
            <div class="field">
              <label for="u-current-pw">Contrase√±a actual</label>
              <input id="u-current-pw" type="password" autocomplete="current-password" placeholder="Actual">
            </div>
            <div class="field">
              <label for="u-new">Nuevo usuario</label>
              <input id="u-new" type="text" autocomplete="username" maxlength="40" placeholder="Nuevo usuario">
            </div>
            <div class="small-note">Es 1 solo usuario: al cambiarlo, el login pedir√° el nuevo nombre.</div>
          `,
          primaryText: 'Guardar',
          onPrimary: async () => {
            const curPw = (document.getElementById('u-current-pw')?.value || '');
            const newU = (document.getElementById('u-new')?.value || '').trim();
            if (!curPw){ alert('Escribe la contrase√±a actual.'); return; }
            if (!newU){ alert('Escribe un usuario.'); return; }
            try{
              await A33Auth.changeUsername({ currentUsername: A33Auth.getUsername(), password: curPw, newUsername: newU });
              hideModal();
              alert('Usuario actualizado. Inicia sesi√≥n de nuevo.');
              await initAuthUi();
            }catch(e){
              alert(e?.message || 'No se pudo cambiar el usuario.');
            }
          },
          cancelText: 'Cancelar',
          onCancel: hideModal
        });
        setTimeout(() => {
          const el = document.getElementById('u-current-pw');
          if (el){ el.focus(); }
        }, 0);
      }

      // --- Usuario (panel) + Calculadora ONLY (export/reset) ---
      const calcOnlyFileInput = document.getElementById('calc-only-file-input');
      let calcOnlySelected = { fileName: '', valid: null, payload: null };

      async function pickCalcOnlyFile(){
        return new Promise((resolve) => {
          if (!calcOnlyFileInput){
            resolve(null);
            return;
          }
          calcOnlyFileInput.value = '';
          const onChange = async () => {
            calcOnlyFileInput.removeEventListener('change', onChange);
            const f = calcOnlyFileInput.files && calcOnlyFileInput.files[0];
            resolve(f || null);
          };
          calcOnlyFileInput.addEventListener('change', onChange, { once:false });
          calcOnlyFileInput.click();
        });
      }

      async function readTextFile(file){
        return new Promise((resolve, reject) => {
          try{
            const r = new FileReader();
            r.onload = () => resolve(String(r.result || ''));
            r.onerror = () => reject(r.error || new Error('No se pudo leer el archivo.'));
            r.readAsText(file);
          }catch(e){ reject(e); }
        });
      }

      function renderCalcOnlyState(){
        const status = document.getElementById('calc-only-status');
        const resetBtn = document.getElementById('btn-reset-suite-keep-calc');
        if (status){
          if (calcOnlySelected && calcOnlySelected.valid && calcOnlySelected.valid.ok){
            status.innerHTML = `‚úÖ <b>${escapeHtml(calcOnlySelected.fileName || 'respaldo')}</b> (v√°lido)`;
          } else if (calcOnlySelected && calcOnlySelected.fileName){
            status.innerHTML = `‚ö†Ô∏è <b>${escapeHtml(calcOnlySelected.fileName)}</b> ‚Äî <span class="muted">${escapeHtml(calcOnlySelected.valid?.reason || 'inv√°lido')}</span>`;
          } else {
            status.textContent = 'Sin archivo seleccionado.';
          }
        }
        if (resetBtn){
          resetBtn.disabled = !(calcOnlySelected && calcOnlySelected.valid && calcOnlySelected.valid.ok);
        }
      }

      function openUserPanel(){
        const a = readAuth();
        const name = a.name || AUTH_DEFAULT_NAME;
        const accessStatus = a.configured ? 'Configurado' : 'No configurado';
        const sessionStatus = a.configured ? (a.authenticated ? 'Activa' : 'Expirada') : 'N/A';
        const username = a.username || '‚Äî';

        showModal({
          title: 'Usuario',
          bodyHtml: `
            <div class="kv">
              <div class="k">Nombre</div><div class="v">${escapeHtml(name)}</div>
              <div class="k">Usuario</div><div class="v">${escapeHtml(username)}</div>
              <div class="k">Acceso</div><div class="v">${escapeHtml(accessStatus)}</div>
              <div class="k">Sesi√≥n</div><div class="v">${escapeHtml(sessionStatus)}</div>
              <div class="k">Dominio</div><div class="v"><span class="muted">${escapeHtml(location.origin)}</span></div>
            </div>

            <hr>

            <div><b>Calculadora</b></div>
            <div class="small-note">Exporta SOLO la Calculadora para guardarla aparte o para restablecer la Suite.</div>

            <div class="btn-row" style="margin-top:0.55rem;">
              <button class="btn btn-ghost" id="btn-export-calc-only">Exportar Calculadora (JSON)</button>
            </div>

            <div style="height:0.35rem;"></div>

            <div><b>Restablecer Suite (conservar Calculadora)</b></div>
            <div class="small-note">Blindado: primero seleccion√° un respaldo v√°lido. Luego confirmaci√≥n doble.</div>

            <div class="btn-row" style="margin-top:0.55rem;">
              <button class="btn btn-ghost" id="btn-pick-calc-only">Seleccionar respaldo Calculadora (JSON)</button>
              <button class="btn btn-danger" id="btn-reset-suite-keep-calc" disabled>Restablecer‚Ä¶</button>
            </div>

            <div class="small-note" id="calc-only-status" style="margin-top:0.45rem;">Sin archivo seleccionado.</div>

            <hr>

            <div><b>Seguridad</b></div>
            <div class="small-note">Acceso local (PWA). Si quer√©s, pod√©s cambiar el usuario/contrase√±a o cerrar la sesi√≥n.</div>

            <div class="btn-row" style="margin-top:0.55rem;">
              <button class="btn btn-ghost" id="btn-change-username">Cambiar usuario</button>
              <button class="btn btn-ghost" id="btn-logout">Cerrar sesi√≥n</button>
            </div>

            <hr>

            <div><b>Autocompletado del navegador</b></div>
            <div class="small-note">Si al escribir la contrase√±a te aparece <b>‚ÄúContrase√±a de este sitio ‚Äî Chrome‚Äù</b> con un usuario viejo (ej. <b>a1</b>), eso est√° guardado en el navegador, no en la Suite.</div>

            <div class="btn-row" style="margin-top:0.55rem;">
              <button class="btn btn-ghost" id="btn-open-pw-manager">Abrir gestor</button>
              <button class="btn btn-ghost" id="btn-copy-domain">Copiar dominio</button>
            </div>

            <details style="margin-top:0.55rem;">
              <summary>Ver pasos (iPad)</summary>
              <div class="small-note" style="margin-top:0.35rem;">
                1) Abr√≠ <b>Chrome</b> ‚Üí Configuraci√≥n ‚Üí <b>Administrador de contrase√±as</b>.<br>
                2) Busc√° <b>${escapeHtml(location.host)}</b> y elimin√°/editar la entrada guardada.<br>
                3) Si a√∫n aparece, revis√° <b>Ajustes del iPad</b> ‚Üí <b>Contrase√±as</b>.
              </div>
            </details>

            <div class="small-note">Todo se guarda localmente en este navegador (modo app / PWA).</div>
          `,
          primaryText: 'Cambiar nombre',
          onPrimary: () => openChangeName(),
          secondaryText: 'Cambiar contrase√±a',
          onSecondary: () => openChangePassword(),
          cancelText: 'Cerrar',
          onCancel: hideModal
        });

        setTimeout(() => {
          // botones existentes
          const btnOpen = document.getElementById('btn-open-pw-manager');
          if (btnOpen){
            btnOpen.onclick = () => {
              try{ window.open('https://passwords.google.com', '_blank', 'noopener'); }
              catch(e){ window.location.href = 'https://passwords.google.com'; }
            };
          }

          const btnCopy = document.getElementById('btn-copy-domain');
          if (btnCopy){
            btnCopy.onclick = async () => {
              const dom = location.origin;
              try{
                if (navigator.clipboard && navigator.clipboard.writeText){
                  await navigator.clipboard.writeText(dom);
                  showToast('Dominio copiado.', 3000);
                } else {
                  prompt('Copi√° el dominio:', dom);
                }
              }catch(e){
                prompt('Copi√° el dominio:', dom);
              }
            };
          }

          const btnChangeU = document.getElementById('btn-change-username');
          if (btnChangeU){
            btnChangeU.onclick = () => openChangeUsername();
          }

          const btnLogout = document.getElementById('btn-logout');
          if (btnLogout){
            btnLogout.onclick = () => {
              A33Auth.logout();
              location.reload();
            };
          }

          // Calculadora: export
          const btnExportCalc = document.getElementById('btn-export-calc-only');
          if (btnExportCalc){
            btnExportCalc.onclick = () => {
              try{
                const payload = buildCalculatorOnlyExport();
                const json = JSON.stringify(payload, null, 2);
                downloadTextFile(buildCalcOnlyFilename(), json);
                showToast('‚úÖ Calculadora exportada (JSON).', 4500);
              }catch(e){
                showToast(`‚ö†Ô∏è No se pudo exportar: ${e?.message || e}`, 5500);
              }
            };
          }

          // Calculadora: seleccionar archivo
          const btnPick = document.getElementById('btn-pick-calc-only');
          if (btnPick){
            btnPick.onclick = async () => {
              const f = await pickCalcOnlyFile();
              if (!f) return;

              calcOnlySelected = { fileName: f.name, valid: null, payload: null };
              renderCalcOnlyState();

              try{
                const text = await readTextFile(f);
                const parsed = safeJsonParse(text);
                if (!parsed.ok){
                  calcOnlySelected.valid = { ok:false, reason:'JSON inv√°lido.' };
                  renderCalcOnlyState();
                  showToast('‚ö†Ô∏è JSON inv√°lido.', 4500);
                  return;
                }

                const v = validateCalculatorOnlyBackup(parsed.obj);
                calcOnlySelected.valid = v;
                calcOnlySelected.payload = v.ok ? v.payload : null;

                renderCalcOnlyState();
                if (v.ok) showToast('‚úÖ Respaldo de Calculadora validado.', 3500);
                else showToast(`‚ö†Ô∏è Respaldo inv√°lido: ${v.reason}`, 6500);
              }catch(e){
                calcOnlySelected.valid = { ok:false, reason: e?.message || String(e) };
                renderCalcOnlyState();
                showToast(`‚ö†Ô∏è No se pudo leer/validar: ${e?.message || e}`, 6500);
              }
            };
          }

          // Restablecer Suite (blindado)
          const btnReset = document.getElementById('btn-reset-suite-keep-calc');
          if (btnReset){
            btnReset.onclick = async () => {
              if (!(calcOnlySelected && calcOnlySelected.valid && calcOnlySelected.valid.ok && calcOnlySelected.payload)){
                showToast('Seleccion√° un JSON v√°lido de Calculadora primero.', 4500);
                return;
              }

              const goBack = () => openUserPanel();

              showModal({
                title: 'Restablecer Suite',
                bodyHtml: `
                  <div class="badge-warn">‚ö†Ô∏è Esto borrar√° <b>TODO</b> en este navegador (POS, Finanzas, Pedidos, etc.).</div>
                  <div class="small-note" style="margin-top:0.4rem;">Se conservar√° la Calculadora usando el JSON validado.</div>
                  <div class="small-note">Tip: cerr√° otras pesta√±as de la Suite para evitar bloqueo.</div>
                `,
                primaryText: 'Continuar',
                onPrimary: () => {
                  showModal({
                    title: 'Confirmaci√≥n final',
                    bodyHtml: `
                      <div class="small-note">Escrib√≠ exactamente <b>BORRAR</b> para confirmar.</div>
                      <div class="field" style="margin-top:0.55rem;">
                        <label for="confirm-borrar">Confirmaci√≥n</label>
                        <input id="confirm-borrar" type="text" placeholder="BORRAR" maxlength="12" style="letter-spacing:0.08em;text-align:center;">
                      </div>
                      <div class="small-note">Si te equivocas, no pasa nada: la Suite se queda intacta.</div>
                    `,
                    primaryText: 'Borrar todo y reiniciar',
                    onPrimary: async () => {
                      const v = (document.getElementById('confirm-borrar')?.value || '').trim();
                      if (v !== 'BORRAR'){
                        showToast('Confirmaci√≥n incorrecta. Escrib√≠ BORRAR (tal cual).', 4500);
                        return;
                      }

                      showModal({
                        title: 'Restableciendo...',
                        bodyHtml: '<div class="muted">Borrando datos y restaurando Calculadora. No cierres esta pesta√±a.</div>',
                        disableCancel: true,
                        disablePrimary: true
                      });

                      try{
                        await resetSuitePreservingCalculator(calcOnlySelected.payload);
                        location.reload();
                      }catch(err){
                        showModal({
                          title: 'No se pudo restablecer',
                          bodyHtml: `<div class="badge-warn">‚ö†Ô∏è ${escapeHtml(err?.message || err)}</div><div class="small-note">Cierra otras pesta√±as de la Suite y reintenta.</div>`,
                          primaryText: 'Volver',
                          onPrimary: () => goBack(),
                          cancelText: 'Cerrar',
                          onCancel: hideModal
                        });
                      }
                    },
                    cancelText: 'Cancelar',
                    onCancel: () => goBack()
                  });

                  setTimeout(() => {
                    const el = document.getElementById('confirm-borrar');
                    if (el) el.focus();
                  }, 0);
                },
                cancelText: 'Cancelar',
                onCancel: () => goBack()
              });
            };
          }

          renderCalcOnlyState();
        }, 0);
      }

      if (userPanelCard){
        userPanelCard.addEventListener('click', openUserPanel);
      }
// Inicializar UI de Usuario
      refreshUserCard();

      if (exportCard){
        exportCard.addEventListener('click', async () => {
          showModal({
            title: 'Resumen del respaldo',
            bodyHtml: '<div class="muted">Generando resumen...</div>',
            primaryText: 'Cerrar',
            onPrimary: hideModal,
            cancelText: 'Cancelar',
            onCancel: hideModal
          });

          try{
            const { backup, jsonString, estimatedBytes, dbSnapshots, lsKeys } = await buildFullBackup();

            const totalDbRecords = dbSnapshots.reduce((acc, d) => {
              const stores = Object.values(d.stores || {});
              return acc + stores.reduce((a, s) => a + (Number(s.count) || 0), 0);
            }, 0);

            const hasAnyData = totalDbRecords > 0 || (lsKeys && lsKeys.length > 0);

            if (!hasAnyData){
              showModal({
                title: 'Resumen del respaldo',
                bodyHtml: '<div class="badge-warn">‚ö†Ô∏è No hay datos para respaldar.</div>',
                primaryText: 'Cerrar',
                onPrimary: hideModal,
                disableCancel: true
              });
              return;
            }

            const summaryHtml = buildSummaryHtmlFromSnapshot({
              dbSnapshots,
              lsKeys,
              exportedAt: backup?.meta?.exportedAt,
              estimatedBytes,
              warnings: [],
              appName: backup?.meta?.appName
            });

            showModal({
              title: 'Resumen del respaldo',
              bodyHtml: summaryHtml,
              primaryText: 'Descargar respaldo',
              onPrimary: async () => {
                downloadTextFile(buildBackupFilename(), jsonString);
                hideModal();
              },
              cancelText: 'Cancelar',
              onCancel: hideModal
            });
          }catch(e){
            showModal({
              title: 'Error',
              bodyHtml: `<div class="badge-warn">‚ö†Ô∏è ${escapeHtml(e?.message || e)}</div>`,
              primaryText: 'Cerrar',
              onPrimary: hideModal,
              disableCancel: true
            });
          }
        });
      }

      if (importCard && fileInput){
        importCard.addEventListener('click', () => {
          fileInput.value = '';
          fileInput.click();
        });

        fileInput.addEventListener('change', async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;

          showModal({
            title: 'Resumen del archivo',
            bodyHtml: '<div class="muted">Leyendo archivo...</div>',
            primaryText: 'Cerrar',
            onPrimary: hideModal,
            cancelText: 'Cancelar',
            onCancel: hideModal
          });

          try{
            const text = await file.text();
            let obj;
            try{
              obj = JSON.parse(text);
            }catch(_){
              throw new Error('JSON inv√°lido o corrupto.');
            }

            const v = validateBackupStructure(obj);
            if (!v.ok) throw new Error(v.reason);

            const sum = summarizeBackupObject(obj);

            // Comparar versiones del respaldo vs las DB existentes en ESTE navegador (solo advertencia, no bloqueo)
            const warnings = await buildDbVersionWarnings(obj);

            const summaryHtml = buildSummaryHtmlFromSnapshot({
              dbSnapshots: sum.dbSnapshots,
              lsKeys: sum.lsKeys,
              exportedAt: sum.exportedAt,
              estimatedBytes: sum.estimatedBytes,
              warnings: warnings,
              appName: sum.appName
            }) + `
              <hr>
              <div class="badge-warn">‚ö†Ô∏è Esto reemplazar√° todos los datos actuales de este navegador.</div>
            `;

            showModal({
              title: 'Resumen del archivo',
              bodyHtml: summaryHtml,
              primaryText: 'Importar y reemplazar',
              onPrimary: async () => {if (!confirm('Esto reemplazar√° TODOS los datos actuales de la Suite A33 en este navegador. ¬øImportar y reemplazar?')) return;

                showModal({
                  title: 'Importando...',
                  bodyHtml: '<div class="muted">Aplicando respaldo... No cierres esta pesta√±a.</div>',
                  disableCancel: true,
                  disablePrimary: true
                });

                try{
                  await performImport(obj);

                  showModal({
                    title: 'Importaci√≥n exitosa',
                    bodyHtml: '<div>‚úÖ Respaldo importado correctamente.</div><div class="small-note">Recomendado: recargar para que todos los m√≥dulos lean los nuevos datos.</div>',
                    primaryText: 'Recargar ahora',
                    onPrimary: () => location.reload(),
                    cancelText: 'M√°s tarde',
                    onCancel: hideModal
                  });
                }catch(err){
                  showModal({
                    title: 'Error de importaci√≥n',
                    bodyHtml: `<div class="badge-warn">‚ö†Ô∏è ${escapeHtml(err?.message || err)}</div><div class="small-note">Tip: cierra otras pesta√±as de la Suite y vuelve a intentar.</div>`,
                    primaryText: 'Cerrar',
                    onPrimary: hideModal,
                    disableCancel: true
                  });
                }
              },
              cancelText: 'Cancelar',
              onCancel: hideModal
            });

          }catch(e){
            showModal({
              title: 'Error',
              bodyHtml: `<div class="badge-warn">‚ö†Ô∏è ${escapeHtml(e?.message || e)}</div>`,
              primaryText: 'Cerrar',
              onPrimary: hideModal,
              disableCancel: true
            });
          }
        });
      }

      // --- Boot: verificar sesi√≥n y decidir si mostrar la app o el lock ---
      // Nota: si esto no corre, el splash de "Verificando sesi√≥n..." queda pegado.
      (async () => {
        try{
          await initAuthUi();
        }catch(e){
          console.error('Error al verificar sesi√≥n:', e);
          // Fail-safe: no dejar el splash colgado.
          try{ showLock(); }catch(_){ hideBootSplash(); }
        }
      })();

      // Fail-safe extra: por si alg√∫n await se cuelga (ej. storage/crypto), nunca bloquear el acceso.
      setTimeout(() => {
        const bs = document.getElementById('boot-splash');
        if (bs && bs.style.display !== 'none'){
          console.warn('Fail-safe: ocultando splash de arranque.');
          try{ showLock(); }catch(_){ hideBootSplash(); }
        }
      }, 2500);

    });
  </script>
  <script src="/assets/js/a33-input-ux.js"></script>
</body>
</html>
