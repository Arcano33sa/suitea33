<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calculadora de Producci√≥n - Arcano 33</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <link rel="icon" type="image/png" sizes="32x32" href="logo-icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="logo-icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 1rem;
      background: #111;
      color: #f5f5f5;
    }
    h1, h2, h3 {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 1.5rem;
    }
    h3 {
      font-size: 0.95rem;
      margin-top: 0.75rem;
    }
    .app-container {
      max-width: 1000px;
      margin: 0 auto;
      background: #1b1b1b;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      border: 1px solid #333;
    }
    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #bbb;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #333;
      padding: 0.35rem;
      text-align: center;
    }
    th {
      background: #272727;
      /* Nota:
         Estas tablas viven dentro de contenedores con max-height + overflow.
         En iPad/iOS, un `top` grande en headers sticky puede tapar filas (ej. Pulso/Media).
         Aqu√≠ el sticky es relativo al scroll del contenedor, as√≠ que `top: 0` es lo correcto. */
      position: sticky;
      top: 0;
      z-index: 2;
    }
    input[type="number"],
    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 0.2rem;
      background: #111;
      border: 1px solid #444;
      border-radius: 4px;
      color: #f5f5f5;
      font-size: 0.8rem;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: #ddbf64;
      box-shadow: 0 0 0 1px #ddbf64;
    }
    .section {
      margin-top: 1rem;
    }
    .hint {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 0.25rem;
    }
    .btn-main {
      margin-top: 1rem;
      width: 100%;
      padding: 0.7rem;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #7b1818, #ddbf64);
      color: #111;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-main:hover {
      filter: brightness(1.05);
    }
    .btn-secondary {
      margin-top: 0.5rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .btn-secondary:hover {
      background: #2c2c2c;
    }
    .results {
      margin-top: 1rem;
      padding: 0.7rem;
      border-radius: 8px;
      background: #161616;
      border: 1px solid #333;
    }
    .results-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .badge {
      padding: 0.3rem 0.6rem;
      border-radius: 999px;
      background: #222;
      border: 1px solid #444;
      font-size: 0.75rem;
      color: #eee;
    }
    .logo-container {
      display: flex;
      justify-content: center;
      margin-bottom: 0.5rem;
      margin-top: 0.5rem;
    }
    .logo-container img {
      width: 96px;
      height: auto;
      border-radius: 16px;
    }
    .fechas-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .fechas-row > div {
      flex: 1 1 140px;
    }
    @media (max-width: 768px) {
      table {
        font-size: 0.78rem;
      }
      th, td {
        padding: 0.25rem;
      }
    }
  </style>
  <link rel="stylesheet" href="/assets/css/a33-header.css" />
</head>
<body>
  <header class="a33-header" role="banner">
    <a class="a33-btn-menu" href="../index.html" aria-label="Volver al Men√∫ principal">‚Üê Men√∫ principal</a>
    <div class="a33-title">Calculadora</div>
    <div class="a33-version">v4.20.4</div>
  </header>

  <div class="app-container">
    <div class="logo-container">
      <img src="logo-icon-192.png" alt="Arcano 33" />
    </div>
    <h1>Calculadora de Producci√≥n ‚Äì Arcano 33</h1>
    <p class="subtitle">
      Define la receta por presentaci√≥n y luego indica cu√°ntas vas a producir. La app te suma la materia prima üîÆ
    </p>

    <div class="section">
      <h2>0. Datos del lote</h2>
      <p class="hint">
        Escribe el nombre o c√≥digo del lote y la fecha de producci√≥n. La fecha de caducidad se calcula 2 meses despu√©s.
      </p>
      <div class="fechas-row">
        <div>
          <label for="lote">Nombre o c√≥digo del lote</label>
          <input type="text" id="lote" placeholder="Ej: Lote 2025-12-01 - Pedido Karen" />
        </div>
        <div>
          <label for="fecha-produccion">Fecha de producci√≥n</label>
          <input type="date" id="fecha-produccion" />
        </div>
      </div>
      <p class="hint" id="texto-caducidad">Fecha de caducidad: ‚Äî</p>
      <p class="hint" id="texto-fecha-hebreo">Fecha hebrea de hoy: ‚Äî</p>

      <h3>Notas del lote</h3>
      <textarea id="notas" placeholder="Ej: Pedido para evento, sabor cl√°sico, entrega s√°bado por la tarde..."></textarea>
    </div>

    <div class="section">
      <h2>1. Receta base (ml por unidad de cada presentaci√≥n)</h2>
      <p class="hint">
        Aqu√≠ pones cu√°ntos ml de <strong>vino, vodka, jugo, sirope y agua pura</strong> lleva 1 unidad de cada presentaci√≥n.
      </p>
      <div style="overflow-x:auto; max-height: 260px;">
        <table id="recetas-table">
          <thead>
            <tr>
              <th>Presentaci√≥n</th>
              <th>Vino (ml)</th>
              <th>Vodka (ml)</th>
              <th>Jugo (ml)</th>
              <th>Sirope (ml)</th>
              <th>Agua pura (ml)</th>
              <th>Costo unitario (C$)</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <button id="btn-guardar-receta" class="btn-secondary">Guardar receta en este navegador</button>
      <p class="hint">Se guarda en el navegador (localStorage). No necesitas cuenta ni internet.</p>
    </div>

    <div class="section">
      <h2>2. Plan de producci√≥n (unidades a preparar)</h2>
      <p class="hint">
        Escribe cu√°ntas unidades har√°s de cada presentaci√≥n. Deja en blanco lo que no vayas a hacer.
      </p>
      <div style="overflow-x:auto;">
        <table id="plan-table">
          <thead>
            <tr>
              <th>Presentaci√≥n</th>
              <th>Unidades a producir</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

    <button id="btn-calcular" class="btn-main">Calcular totales de materia prima</button>

    <div id="resultados" class="results" style="display:none;">
      <div class="results-title">3. Totales de materia prima necesaria</div>
      <div id="resumen-lote"></div>
      <div id="resumen-fechas"></div>
      <div id="totales-ingredientes"></div>
      <div id="resumen-costos"></div>

      <div class="results-title" style="margin-top:0.8rem;">Resumen de volumen final</div>
      <div id="resumen-volumen"></div>

      <button id="btn-guardar-lote" class="btn-secondary">Guardar c√°lculo como lote</button>
      <p class="hint">Guardar√° este c√°lculo en el Control de Lotes interno.</p>
      <button id="btn-exportar" class="btn-secondary">Exportar informaci√≥n del lote (TXT)</button>
      <p class="hint">Se descargar√° un archivo .txt con el resumen del lote.</p>
    </div>

    <button id="btn-limpiar" class="btn-secondary">Limpiar cantidades (no borra recetas)</button>
  </div>

  <script src="/assets/js/a33-storage.js"></script>
  <script src="/assets/js/a33-presentations.js"></script>
  <script src="/assets/js/a33-auth.js"></script>
  <script>
    if (!(A33Auth.isConfigured() && A33Auth.isAuthenticated())){
      location.href = "../index.html";
    }
  </script>
  <script>
    const INGREDIENTES = ["vino", "vodka", "jugo", "sirope", "agua"];
    const PRESENTACIONES = [
      { id: "pulso",  nombre: "Pulso 250 ml",  volumenMl: 250 },
      { id: "media",  nombre: "Media 375 ml",  volumenMl: 375 },
      { id: "djeba",  nombre: "Djeba 750 ml",  volumenMl: 750 },
      { id: "litro",  nombre: "Litro 1000 ml", volumenMl: 1000 },
      { id: "galon",  nombre: "Gal√≥n 3750 ml", volumenMl: 3750 }
    ];
    const STORAGE_RECETAS_KEY = "arcano33_recetas_v1";
    const STORAGE_LOTE_KEY = "arcano33_lote_actual";
    const STORAGE_FECHA_PROD_KEY = "arcano33_fecha_produccion";
    const STORAGE_NOTAS_KEY = "arcano33_notas_lote";
    const STORAGE_KEY_INVENTARIO = "arcano33_inventario";

    function hoyLocalISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }


    function invParseNumber(value) {
      const n = parseFloat(String(value).replace(",", "."));
      return Number.isNaN(n) ? 0 : n;
    }

    function invDefault() {
      return {
        liquids: {
          vino:   { stock: 0, max: 0 },
          vodka:  { stock: 0, max: 0 },
          jugo:   { stock: 0, max: 0 },
          sirope: { stock: 0, max: 0 },
          agua:   { stock: 0, max: 0 }
        },
        bottles: {
          pulso: { stock: 0 },
          media: { stock: 0 },
          djeba: { stock: 0 },
          litro: { stock: 0 },
          galon: { stock: 0 }
        },
        finished: {
          pulso: { stock: 0 },
          media: { stock: 0 },
          djeba: { stock: 0 },
          litro: { stock: 0 },
          galon: { stock: 0 }
        }
      };
    }

    function invLoad() {
      try {
        const raw = A33Storage.getItem(STORAGE_KEY_INVENTARIO);
        let data = raw ? JSON.parse(raw) : null;
        if (!data || typeof data !== "object") data = invDefault();
        if (!data.liquids) data.liquids = {};
        if (!data.bottles) data.bottles = {};
        if (!data.finished) data.finished = {};
        const d = invDefault();
        Object.keys(d.liquids).forEach((k) => {
          if (!data.liquids[k]) data.liquids[k] = { stock: 0, max: 0 };
          data.liquids[k].stock = invParseNumber(data.liquids[k].stock || 0);
          data.liquids[k].max = invParseNumber(data.liquids[k].max || 0);
        });
        Object.keys(d.bottles).forEach((k) => {
          if (!data.bottles[k]) data.bottles[k] = { stock: 0 };
          data.bottles[k].stock = invParseNumber(data.bottles[k].stock || 0);
        });
        Object.keys(d.finished || {}).forEach((k) => {
          if (!data.finished[k]) data.finished[k] = { stock: 0 };
          data.finished[k].stock = invParseNumber(data.finished[k].stock || 0);
        });
        return data;
      } catch (e) {
        console.warn("No se pudo leer inventario, usando valores por defecto.", e);
        return invDefault();
      }
    }

    function invSave(inv) {
      try {
        A33Storage.setItem(STORAGE_KEY_INVENTARIO, JSON.stringify(inv));
      } catch (e) {
        console.warn("No se pudo guardar el inventario.", e);
      }
    }

    function invBuildAlertLines(inv) {
      const lines = [];
      // L√≠quidos por debajo de 20 %
      Object.entries(inv.liquids || {}).forEach(([id, info]) => {
        const stock = invParseNumber(info.stock);
        const max = invParseNumber(info.max);
        if (max > 0) {
          const pct = (stock / max) * 100;
          if (pct <= 20) {
            let nombre = id;
            if (id === "vino") nombre = "Vino";
            if (id === "vodka") nombre = "Vodka";
            if (id === "jugo") nombre = "Jugo";
            if (id === "sirope") nombre = "Sirope";
            if (id === "agua") nombre = "Agua pura";
            lines.push("‚Ä¢ " + nombre + ": " + stock.toFixed(0) + " ml (" + pct.toFixed(1) + "% restante)");
          }
        }
      });
      // Botellas con 10 o menos unidades
      Object.entries(inv.bottles || {}).forEach(([id, info]) => {
        const stock = invParseNumber(info.stock);
        if (stock <= 10) {
          let nombre = id;
          if (id === "pulso") nombre = "Pulso 250 ml";
          if (id === "media") nombre = "Media 375 ml";
          if (id === "djeba") nombre = "Djeba 750 ml";
          if (id === "litro") nombre = "Litro 1000 ml";
          if (id === "galon") nombre = "Gal√≥n 3750 ml";
          lines.push("‚Ä¢ " + nombre + ": " + stock.toFixed(0) + " botellas");
        }
      });
      // Producto terminado con 10 o menos unidades
      Object.entries(inv.finished || {}).forEach(([id, info]) => {
        const stock = invParseNumber(info.stock);
        if (stock <= 10) {
          let nombre = id;
          if (id === "pulso") nombre = "Pulso 250 ml listo";
          if (id === "media") nombre = "Media 375 ml lista";
          if (id === "djeba") nombre = "Djeba 750 ml lista";
          if (id === "litro") nombre = "Litro 1000 ml listo";
          if (id === "galon") nombre = "Gal√≥n 3750 ml listo";
          lines.push("‚Ä¢ " + nombre + ": " + stock.toFixed(0) + " botellas listas");
        }
      });
      return lines;
    }

    function aplicarConsumoInventarioDesdeLote(datos, mapUnits) {
      if (!datos || !datos.totalesIngredientes) return;
      let inv = invLoad();

      // Restar l√≠quidos
      ["vino","vodka","jugo","sirope","agua"].forEach((ing) => {
        const uso = typeof datos.totalesIngredientes[ing] === "number" ? datos.totalesIngredientes[ing] : 0;
        if (!inv.liquids[ing]) {
          inv.liquids[ing] = { stock: 0, max: 0 };
        }
        inv.liquids[ing].stock = invParseNumber(inv.liquids[ing].stock) - uso;
      });

      // Restar botellas por presentaci√≥n
      const map = mapUnits || {};
      ["pulso","media","djeba","litro","galon"].forEach((id) => {
        const uso = typeof map[id] === "number" ? map[id] : 0;
        if (!inv.bottles[id]) {
          inv.bottles[id] = { stock: 0 };
        }
        inv.bottles[id].stock = invParseNumber(inv.bottles[id].stock) - uso;
        // Sumar producto terminado (botellas listas)
        if (!inv.finished) inv.finished = {};
        if (!inv.finished[id]) {
          inv.finished[id] = { stock: 0 };
        }
        inv.finished[id].stock = invParseNumber(inv.finished[id].stock) + uso;
      });

      invSave(inv);

      const lines = invBuildAlertLines(inv);
      if (lines.length > 0) {
        alert("Alerta de inventario (despu√©s de registrar el lote):\n\n" + lines.join("\\n"));
      }
    }


    function getNumberValue(id) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const raw = (el.value || "").toString().replace(",", ".");
      const v = parseFloat(raw);
      return isNaN(v) ? 0 : v;
    }
    function formatMl(value) {
      return value.toFixed(0) + " ml";
    }
    function formatLitros(valueMl) {
      const litros = valueMl / 1000;
      return litros.toFixed(2) + " L";
    }
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function slugify(text) {
      return text
        .toString()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .substring(0, 40) || "arcano33";
    }
    function formatearFechaBonita(date) {
      if (!date) return "";
      const d = date.getDate().toString().padStart(2, "0");
      const m = (date.getMonth() + 1).toString().padStart(2, "0");
      const y = date.getFullYear();
      return d + "/" + m + "/" + y;
    }
    function calcularCaducidad(fechaProdStr) {
      if (!fechaProdStr) return null;
      const partes = fechaProdStr.split("-");
      if (partes.length !== 3) return null;
      const year = parseInt(partes[0], 10);
      const month = parseInt(partes[1], 10) - 1;
      const day = parseInt(partes[2], 10);
      if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
      const fecha = new Date(year, month, day);
      if (isNaN(fecha.getTime())) return null;
      const cad = new Date(fecha);
      cad.setMonth(cad.getMonth() + 2);
      return cad;
    }
    function actualizarTextoCaducidad() {
      const fechaProdInput = document.getElementById("fecha-produccion");
      const textoCad = document.getElementById("texto-caducidad");
      const valor = fechaProdInput.value;
      const cad = calcularCaducidad(valor);
      if (!valor) {
        textoCad.textContent = "Fecha de caducidad: ‚Äî";
      } else if (!cad) {
        textoCad.textContent = "Fecha de caducidad: (fecha de producci√≥n no v√°lida)";
      } else {
        textoCad.textContent = "Fecha de caducidad: " + formatearFechaBonita(cad);
      }
    }
    function actualizarFechaHebrea() {
      const span = document.getElementById("texto-fecha-hebreo");
      if (!span) return;
      try {
        const hoy = new Date();
        const y = hoy.getFullYear();
        const m = hoy.getMonth() + 1;
        const d = hoy.getDate();
        const url = "https://www.hebcal.com/converter?cfg=json&g2h=1&gy=" + y + "&gm=" + m + "&gd=" + d + "&lang=es";
        fetch(url)
          .then(res => {
            if (!res.ok) throw new Error("Respuesta no v√°lida");
            return res.json();
          })
          .then(data => {
            if (data && typeof data.hd !== "undefined" && data.hm && data.hy) {
              span.textContent = "Fecha hebrea de hoy: " + data.hd + " " + data.hm + " " + data.hy;
            } else {
              span.textContent = "Fecha hebrea de hoy: ‚Äî";
            }
          })
          .catch(err => {
            console.warn("No se pudo obtener la fecha hebrea:", err);
            span.textContent = "Fecha hebrea de hoy: ‚Äî";
          });
      } catch (e) {
        console.warn("No se pudo obtener la fecha hebrea:", e);
        span.textContent = "Fecha hebrea de hoy: ‚Äî";
      }
    }

    function construirTablaRecetas() {
      const tbody = document.querySelector("#recetas-table tbody");
      tbody.innerHTML = "";
      PRESENTACIONES.forEach(p => {
        const tr = document.createElement("tr");
        const tdNombre = document.createElement("td");
        tdNombre.textContent = p.nombre;
        tdNombre.style.textAlign = "left";
        tr.appendChild(tdNombre);
        INGREDIENTES.forEach(ing => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          input.type = "number";
          input.min = "0";
          input.step = "0.01";
          input.id = "receta-" + p.id + "-" + ing;
          input.placeholder = "0";
          td.appendChild(input);
          tr.appendChild(td);
        });
        // columna de costo unitario por presentaci√≥n
        const tdCosto = document.createElement("td");
        const inputCosto = document.createElement("input");
        inputCosto.type = "number";
        inputCosto.min = "0";
        inputCosto.step = "0.01";
        inputCosto.id = "costo-unit-" + p.id;
        inputCosto.placeholder = "0";
        tdCosto.appendChild(inputCosto);
        tr.appendChild(tdCosto);

        tbody.appendChild(tr);
      });
    }

    function construirTablaPlan() {
      const tbody = document.querySelector("#plan-table tbody");
      tbody.innerHTML = "";
      PRESENTACIONES.forEach(p => {
        const tr = document.createElement("tr");
        const tdNombre = document.createElement("td");
        tdNombre.textContent = p.nombre;
        tdNombre.style.textAlign = "left";
        tr.appendChild(tdNombre);
        const tdCantidad = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.id = "plan-" + p.id;
        input.placeholder = "0";
        tdCantidad.appendChild(input);
        tr.appendChild(tdCantidad);
        tbody.appendChild(tr);
      });
    }
    function guardarRecetas() {
      const recetas = {};
      const costosPresentacion = {};
      PRESENTACIONES.forEach(p => {
        recetas[p.id] = {};
        INGREDIENTES.forEach(ing => {
          const val = getNumberValue("receta-" + p.id + "-" + ing);
          recetas[p.id][ing] = val;
        });
        const costoUnit = getNumberValue("costo-unit-" + p.id);
        costosPresentacion[p.id] = {
          id: p.id,
          nombre: p.nombre,
          costoUnidad: costoUnit
        };
      });
      const payload = {
        version: 2,
        recetas,
        costosPresentacion
      };
      A33Storage.setItem(STORAGE_RECETAS_KEY, JSON.stringify(payload));
      alert("Recetas y costos guardados en este navegador ‚úÖ");
    }

    function cargarRecetas() {
      const raw = A33Storage.getItem(STORAGE_RECETAS_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        const recetas = data && data.recetas ? data.recetas : data;
        const costosPresentacion = data && data.costosPresentacion ? data.costosPresentacion : null;

        // cargar recetas (ml)
        PRESENTACIONES.forEach(p => {
          const rec = recetas[p.id];
          if (!rec) return;
          INGREDIENTES.forEach(ing => {
            const input = document.getElementById("receta-" + p.id + "-" + ing);
            if (!input) return;
            const val = rec[ing];
            if (typeof val === "number") {
              input.value = val;
            }
          });
        });

        // cargar costos por presentaci√≥n si existen
        if (costosPresentacion) {
          PRESENTACIONES.forEach(p => {
            const info = costosPresentacion[p.id];
            if (!info) return;
            const inputCosto = document.getElementById("costo-unit-" + p.id);
            if (inputCosto && typeof info.costoUnidad === "number") {
              inputCosto.value = info.costoUnidad;
            }
          });
        }
      } catch (e) {
        console.warn("Error cargando recetas:", e);
      }
    }

    function guardarMetaLote() {
      const loteInput = document.getElementById("lote");
      const fechaProdInput = document.getElementById("fecha-produccion");
      const notasInput = document.getElementById("notas");
      if (loteInput) {
        A33Storage.setItem(STORAGE_LOTE_KEY, loteInput.value || "");
      }
      if (fechaProdInput) {
        // En Calculadora no se editan registros existentes: no persistimos la fecha entre sesiones.
        A33Storage.removeItem(STORAGE_FECHA_PROD_KEY);
      }
      if (notasInput) {
        A33Storage.setItem(STORAGE_NOTAS_KEY, notasInput.value || "");
      }
      actualizarTextoCaducidad();
    }
    function cargarMetaLote() {
      const loteInput = document.getElementById("lote");
      const fechaProdInput = document.getElementById("fecha-produccion");
      const notasInput = document.getElementById("notas");
      const loteVal = A33Storage.getItem(STORAGE_LOTE_KEY);
      const notasVal = A33Storage.getItem(STORAGE_NOTAS_KEY);
      if (loteInput && loteVal !== null) loteInput.value = loteVal;
      if (fechaProdInput) {
        // Compatibilidad: si qued√≥ una fecha vieja guardada, la limpiamos.
        A33Storage.removeItem(STORAGE_FECHA_PROD_KEY);
        fechaProdInput.value = hoyLocalISO();
      }
      if (notasInput && notasVal !== null) notasInput.value = notasVal;
      actualizarTextoCaducidad();
    }
    function calcularDatosLote() {
      const totalesIngredientes = { vino: 0, vodka: 0, jugo: 0, sirope: 0, agua: 0 };
      let totalVolumenFinalMl = 0;
      const unidadesPorPresentacion = [];
      PRESENTACIONES.forEach(p => {
        const unidades = getNumberValue("plan-" + p.id);
        if (unidades > 0) {
          unidadesPorPresentacion.push({ id: p.id, nombre: p.nombre, unidades });
        }
        if (unidades <= 0) return;
        INGREDIENTES.forEach(ing => {
          const mlPorUnidad = getNumberValue("receta-" + p.id + "-" + ing);
          totalesIngredientes[ing] += unidades * mlPorUnidad;
        });
        totalVolumenFinalMl += unidades * p.volumenMl;
      });
      const loteNombre = (document.getElementById("lote").value || "").trim();
      const fechaProdStr = document.getElementById("fecha-produccion").value || "";
      const fechaProd = fechaProdStr ? new Date(fechaProdStr + "T00:00:00") : null;
      const fechaCad = calcularCaducidad(fechaProdStr);
      const notas = document.getElementById("notas").value || "";
      return {
        totalesIngredientes,
        totalVolumenFinalMl,
        unidadesPorPresentacion,
        loteNombre,
        fechaProd,
        fechaProdStr,
        fechaCad,
        notas
      };
    }
    function calcularTotales() {
      const datos = calcularDatosLote();
      const resultadosDiv = document.getElementById("resultados");
      const totalesDiv = document.getElementById("totales-ingredientes");
      const resumenVolumenDiv = document.getElementById("resumen-volumen");
      const resumenLoteDiv = document.getElementById("resumen-lote");
      const resumenFechasDiv = document.getElementById("resumen-fechas");

      const loteNombre = datos.loteNombre;
      let htmlLote = "";
      if (loteNombre) {
        htmlLote = "<div class='flex-row'><div class='badge'>Lote: <strong>" +
          escapeHtml(loteNombre) +
          "</strong></div></div>";
      } else {
        htmlLote = "<div class='flex-row'><div class='badge'>Lote sin nombre</div></div>";
      }
      resumenLoteDiv.innerHTML = htmlLote;

      let htmlFechas = "<div class='flex-row'>";
      if (datos.fechaProd) {
        htmlFechas += "<div class='badge'>Producci√≥n: <strong>" + formatearFechaBonita(datos.fechaProd) + "</strong></div>";
      } else {
        htmlFechas += "<div class='badge'>Producci√≥n: ‚Äî</div>";
      }
      if (datos.fechaCad) {
        htmlFechas += "<div class='badge'>Caducidad: <strong>" + formatearFechaBonita(datos.fechaCad) + "</strong></div>";
      } else {
        htmlFechas += "<div class='badge'>Caducidad: ‚Äî</div>";
      }
      if (datos.notas) {
        htmlFechas += "<div class='badge'>Notas: " + escapeHtml(datos.notas.substring(0, 60)) + (datos.notas.length > 60 ? "..." : "") + "</div>";
      }
      htmlFechas += "</div>";
      resumenFechasDiv.innerHTML = htmlFechas;

      let htmlTotales = "<table><thead><tr><th>Ingrediente</th><th>Total (ml)</th><th>Equivalente (L)</th></tr></thead><tbody>";
      htmlTotales += "<tr><td style='text-align:left;'>Vino</td><td>" + formatMl(datos.totalesIngredientes.vino) + "</td><td>" + formatLitros(datos.totalesIngredientes.vino) + "</td></tr>";
      htmlTotales += "<tr><td style='text-align:left;'>Vodka</td><td>" + formatMl(datos.totalesIngredientes.vodka) + "</td><td>" + formatLitros(datos.totalesIngredientes.vodka) + "</td></tr>";
      htmlTotales += "<tr><td style='text-align:left;'>Jugo</td><td>" + formatMl(datos.totalesIngredientes.jugo) + "</td><td>" + formatLitros(datos.totalesIngredientes.jugo) + "</td></tr>";
      htmlTotales += "<tr><td style='text-align:left;'>Sirope</td><td>" + formatMl(datos.totalesIngredientes.sirope) + "</td><td>" + formatLitros(datos.totalesIngredientes.sirope) + "</td></tr>";
      htmlTotales += "<tr><td style='text-align:left;'>Agua pura</td><td>" + formatMl(datos.totalesIngredientes.agua) + "</td><td>" + formatLitros(datos.totalesIngredientes.agua) + "</td></tr>";
      htmlTotales += "</tbody></table>";
      totalesDiv.innerHTML = htmlTotales;


      const resumenCostosDiv = document.getElementById("resumen-costos");
      if (resumenCostosDiv) {
        let costoTotal = 0;
        const filas = [];
        datos.unidadesPorPresentacion.forEach(item => {
          const costoUnit = getNumberValue("costo-unit-" + item.id);
          if (costoUnit > 0 && item.unidades > 0) {
            const subtotal = costoUnit * item.unidades;
            costoTotal += subtotal;
            filas.push({
              nombre: item.nombre,
              unidades: item.unidades,
              costoUnidad: costoUnit,
              subtotal
            });
          }
        });

        let htmlCostos = "";
        if (filas.length) {
          htmlCostos += "<div class='flex-row'>";
          htmlCostos += "<div class='badge'>Costo total estimado del lote: <strong>C$ " + costoTotal.toFixed(2) + "</strong></div>";
          if (datos.totalVolumenFinalMl > 0) {
            const costoPorLitro = costoTotal / (datos.totalVolumenFinalMl / 1000);
            htmlCostos += "<div class='badge'>Costo aprox. por litro: <strong>C$ " + costoPorLitro.toFixed(2) + "</strong></div>";
          }
          htmlCostos += "</div>";

          htmlCostos += "<table><thead><tr><th>Presentaci√≥n</th><th>Unidades</th><th>Costo unitario (C$)</th><th>Subtotal (C$)</th></tr></thead><tbody>";
          filas.forEach(f => {
            htmlCostos += "<tr>";
            htmlCostos += "<td style='text-align:left;'>" + escapeHtml(f.nombre) + "</td>";
            htmlCostos += "<td>" + f.unidades + "</td>";
            htmlCostos += "<td>" + f.costoUnidad.toFixed(2) + "</td>";
            htmlCostos += "<td>" + f.subtotal.toFixed(2) + "</td>";
            htmlCostos += "</tr>";
          });
          htmlCostos += "</tbody></table>";
        } else {
          htmlCostos = "<p class='hint'>Para ver costos, llena la columna de costo unitario y el plan de producci√≥n.</p>";
        }

        resumenCostosDiv.innerHTML = htmlCostos;
      }

      let htmlResumen = "<div class='flex-row'><div class='badge'>Volumen final te√≥rico: <strong>" +
        formatLitros(datos.totalVolumenFinalMl) +
        "</strong></div></div>";
      resumenVolumenDiv.innerHTML = htmlResumen;

      resultadosDiv.style.display = "block";
      guardarMetaLote();
    }
    function exportarLote() {
      const datos = calcularDatosLote();
      const ahora = new Date();
      const fechaStr = ahora.toLocaleString("es-NI");
      let texto = "";
      const loteNombre = datos.loteNombre || "Lote sin nombre";
      texto += "Arcano 33 - Resumen de lote\n";
      texto += "================================\n\n";
      texto += "Lote: " + loteNombre + "\n";
      texto += "Fecha de exportaci√≥n: " + fechaStr + "\n";
      if (datos.fechaProd) {
        texto += "Fecha de producci√≥n: " + formatearFechaBonita(datos.fechaProd) + "\n";
      } else {
        texto += "Fecha de producci√≥n: ‚Äî\n";
      }
      if (datos.fechaCad) {
        texto += "Fecha de caducidad: " + formatearFechaBonita(datos.fechaCad) + "\n";
      } else {
        texto += "Fecha de caducidad: ‚Äî\n";
      }
      texto += "\n";
      texto += "Unidades por presentaci√≥n:\n";
      if (datos.unidadesPorPresentacion.length === 0) {
        texto += "- (sin unidades)\n";
      } else {
        datos.unidadesPorPresentacion.forEach(item => {
          texto += "- " + item.nombre + ": " + item.unidades + " unidad(es)\n";
        });
      }
      texto += "\n";
      texto += "Totales de materia prima:\n";
      texto += "- Vino: " + datos.totalesIngredientes.vino.toFixed(0) + " ml (" + formatLitros(datos.totalesIngredientes.vino) + ")\n";
      texto += "- Vodka: " + datos.totalesIngredientes.vodka.toFixed(0) + " ml (" + formatLitros(datos.totalesIngredientes.vodka) + ")\n";
      texto += "- Jugo: " + datos.totalesIngredientes.jugo.toFixed(0) + " ml (" + formatLitros(datos.totalesIngredientes.jugo) + ")\n";
      texto += "- Sirope: " + datos.totalesIngredientes.sirope.toFixed(0) + " ml (" + formatLitros(datos.totalesIngredientes.sirope) + ")\n";
      texto += "- Agua pura: " + datos.totalesIngredientes.agua.toFixed(0) + " ml (" + formatLitros(datos.totalesIngredientes.agua) + ")\n";
      texto += "\n";
      texto += "Volumen final te√≥rico: " + formatLitros(datos.totalVolumenFinalMl) + "\n";
      if (datos.notas) {
        texto += "\nNotas del lote:\n" + datos.notas + "\n";
      }
      const blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const slug = slugify(loteNombre);
      a.download = "lote-" + slug + ".txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function limpiarCantidades() {
      PRESENTACIONES.forEach(p => {
        const el = document.getElementById("plan-" + p.id);
        if (el) el.value = "";
      });
      document.getElementById("resultados").style.display = "none";
    }
    
    function guardarCalculoComoLote() {
      const datos = calcularDatosLote();
      const loteNombre = datos.loteNombre || "";
      if (!loteNombre) {
        alert("Primero escribe un nombre o c√≥digo para el lote.");
        return;
      }
      if (!datos.unidadesPorPresentacion.length) {
        if (!confirm("No hay unidades indicadas en el plan de producci√≥n. ¬øGuardar de todas formas?")) {
          return;
        }
      }
      let lotes = [];
      try {
        const raw = A33Storage.getItem("arcano33_lotes");
        if (raw) lotes = JSON.parse(raw) || [];
        if (!Array.isArray(lotes)) lotes = [];
      } catch (e) {
        lotes = [];
      }
      const mapUnits = { pulso: 0, media: 0, djeba: 0, litro: 0, galon: 0 };
      datos.unidadesPorPresentacion.forEach((item) => {
        if (item.id === "pulso") mapUnits.pulso = item.unidades;
        if (item.id === "media") mapUnits.media = item.unidades;
        if (item.id === "djeba") mapUnits.djeba = item.unidades;
        if (item.id === "litro") mapUnits.litro = item.unidades;
        if (item.id === "galon") mapUnits.galon = item.unidades;
      });
      const fechaProdIso = datos.fechaProdStr || hoyLocalISO();
      let caducidadIso = "";
      try {
        const cad = calcularCaducidad(fechaProdIso);
        if (cad) caducidadIso = cad.toISOString().slice(0, 10);
      } catch (e) {
        caducidadIso = "";
      }
      const nuevoLote = {
        id: "lote_" + Date.now(),
        fecha: fechaProdIso,
        codigo: loteNombre,
        caducidad: caducidadIso || fechaProdIso,
        volTotal: Math.round(datos.totalVolumenFinalMl || 0).toString(),
        volVino: Math.round(datos.totalesIngredientes.vino || 0).toString(),
        volVodka: Math.round(datos.totalesIngredientes.vodka || 0).toString(),
        volJugo: Math.round(datos.totalesIngredientes.jugo || 0).toString(),
        volSirope: Math.round(datos.totalesIngredientes.sirope || 0).toString(),
        volAgua: Math.round(datos.totalesIngredientes.agua || 0).toString(),
        pulso: (mapUnits.pulso || 0).toString(),
        media: (mapUnits.media || 0).toString(),
        djeba: (mapUnits.djeba || 0).toString(),
        litro: (mapUnits.litro || 0).toString(),
        galon: (mapUnits.galon || 0).toString(),
        notas: datos.notas || "",
        createdAt: new Date().toISOString()
      };
      lotes.push(nuevoLote);
      // Ajustar inventario global seg√∫n este lote
      aplicarConsumoInventarioDesdeLote(datos, mapUnits);
      try {
        A33Storage.setItem("arcano33_lotes", JSON.stringify(lotes));
        alert("Lote guardado en el Control de Lotes interno.");
      } catch (e) {
        alert("No se pudo guardar el lote en el navegador.");
      }
    }
function init() {
      construirTablaRecetas();
      construirTablaPlan();
      cargarRecetas();
      cargarMetaLote();
      document.getElementById("btn-guardar-receta").addEventListener("click", guardarRecetas);
      document.getElementById("btn-calcular").addEventListener("click", calcularTotales);
      document.getElementById("btn-limpiar").addEventListener("click", limpiarCantidades);
      const btnGuardarLote = document.getElementById("btn-guardar-lote");
      if (btnGuardarLote) btnGuardarLote.addEventListener("click", guardarCalculoComoLote);
      document.getElementById("btn-exportar").addEventListener("click", exportarLote);
      const loteInput = document.getElementById("lote");
      const fechaProdInput = document.getElementById("fecha-produccion");
      const notasInput = document.getElementById("notas");
      loteInput.addEventListener("change", guardarMetaLote);
      loteInput.addEventListener("keyup", guardarMetaLote);
      fechaProdInput.addEventListener("change", guardarMetaLote);
      fechaProdInput.addEventListener("keyup", guardarMetaLote);
      notasInput.addEventListener("change", guardarMetaLote);
      notasInput.addEventListener("keyup", guardarMetaLote);
      fechaProdInput.addEventListener("change", actualizarTextoCaducidad);
      actualizarTextoCaducidad();
      actualizarFechaHebrea();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
  <script src="/assets/js/a33-input-ux.js"></script>
</body>
</html>
