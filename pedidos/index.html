<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Arcano 33 · Planificación de Pedidos</title>
  <meta name="description" content="Planificación y registro de pedidos y entregas de Sangría Artesanal Premium Arcano 33." />
  <meta name="theme-color" content="#7b1818" />

  <link rel="icon" type="image/png" sizes="192x192" href="images/logo.png" />
  <link rel="apple-touch-icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.webmanifest?v=4.20.77&r=1" />

  <link rel="stylesheet" href="style.css?v=4.20.77&r=1" />
  <link rel="stylesheet" href="/assets/css/a33-header.css?v=4.20.77&r=1" />
</head>
<body>
  <header class="a33-header" role="banner">
    <a class="a33-btn-menu" href="../index.html" aria-label="Volver al Menú principal">← Menú principal</a>
    <div class="a33-title">Planificación de Pedidos</div>
    <div class="a33-version" data-a33-version="1" data-a33-fallback="v4.20.77">v...</div>
  </header>
  <main class="app-main">
    <section class="card form-card">
      <h2>Nuevo pedido</h2>
      <div class="inline-banner" id="archived-mode-banner" hidden></div>
      <form id="pedido-form">
        <div class="form-grid">
          <div class="field">
            <label for="fechaCreacion">Fecha de Fabricación</label>
            <input type="date" id="fechaCreacion" name="fechaCreacion" required />
          </div>

          <div class="field">
            <label for="fechaEntrega">Fecha de entrega</label>
            <input type="date" id="fechaEntrega" name="fechaEntrega" required />
          </div>

          <div class="field">
            <label for="codigoPedido">Código de pedido</label>
            <input type="text" id="codigoPedido" name="codigoPedido" placeholder="Se autogenera" readonly />
          </div>

          <div class="field">
            <label for="prioridad">Prioridad</label>
            <select id="prioridad" name="prioridad">
              <option value="normal">Normal</option>
              <option value="urgente">Urgente</option>
              <option value="programado">Programado</option>
            </select>
          </div>
        </div>

        <h3>Datos del cliente</h3>
        <div class="form-grid">
          <div class="field">
            <label for="clienteSelect">Cliente</label>

            <div class="customer-picker" role="group" aria-label="Selector de cliente">
              <input type="text" id="clienteBuscar" placeholder="Buscar cliente..." autocomplete="off" inputmode="search" />
              <select id="clienteSelect" required></select>
              <button type="button" class="btn-secondary a33-pill-btn" id="clienteNewToggle">+ Crear nuevo</button>
            </div>

            <div id="clienteNewBox" class="customer-new-box" hidden>
              <input type="text" id="clienteNewName" placeholder="Nombre del nuevo cliente" autocomplete="off" />
              <div class="customer-new-actions">
                <button type="button" class="btn-primary a33-pill-btn" id="clienteNewSave">Guardar</button>
                <button type="button" class="btn-secondary a33-pill-btn" id="clienteNewCancel">Cancelar</button>
              </div>
              <p class="hint hint-small">Se guarda también para POS (misma base de clientes).</p>
            </div>

            <div id="clienteSelectedStatus" class="hint hint-small" aria-live="polite"></div>

            <!-- Compat: seguimos guardando clienteNombre, pero ahora viene del selector -->
            <input type="hidden" id="clienteNombre" name="clienteNombre" />
            <input type="hidden" id="clienteId" name="clienteId" />
          </div>

          <div class="field">
            <label for="clienteTipo">Tipo de cliente</label>
            <select id="clienteTipo" name="clienteTipo">
              <option value="individual">Individual</option>
              <option value="bar">Bar</option>
              <option value="restaurante">Restaurante</option>
              <option value="evento">Evento</option>
            </select>
          </div>

          <div class="field">
            <label for="clienteTelefono">Teléfono de contacto</label>
            <input type="tel" id="clienteTelefono" name="clienteTelefono" placeholder="Ej: 8888-0000" />
          </div>

          <!-- Dirección de entrega: removida de UI (se mantiene hidden para compatibilidad con pedidos viejos) -->
          <input type="hidden" id="clienteDireccion" name="clienteDireccion" />

          <div class="field" style="grid-column:1/-1;">
            <label for="clienteReferencia">Referencia de ubicación</label>
            <textarea id="clienteReferencia" name="clienteReferencia" rows="2" placeholder="Punto de referencia, indicaciones extra (opcional)"></textarea>
          </div>
        </div>

        <h3>Detalle del pedido · Presentaciones</h3>
        <p class="hint">Solo presentación y cantidad. Los precios se toman automáticamente del POS.</p>

        <div class="presentaciones-wrapper">
          <table class="mini-table" id="presentaciones-table">
            <thead>
              <tr>
                <th>Presentación</th>
                <th class="qty-col">Cantidad</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Pulso 250 ml</td>
                <td><input type="number" id="pulsoCant" min="0" step="1" value="0" class="a33-num" data-a33-default="0" inputmode="numeric"></td>
              </tr>
              <tr>
                <td>Media 375 ml</td>
                <td><input type="number" id="mediaCant" min="0" step="1" value="0" class="a33-num" data-a33-default="0" inputmode="numeric"></td>
              </tr>
              <tr>
                <td>Djeba 750 ml</td>
                <td><input type="number" id="djebaCant" min="0" step="1" value="0" class="a33-num" data-a33-default="0" inputmode="numeric"></td>
              </tr>
              <tr>
                <td>Litro 1000 ml</td>
                <td><input type="number" id="litroCant" min="0" step="1" value="0" class="a33-num" data-a33-default="0" inputmode="numeric"></td>
              </tr>
              <tr>
                <td>Galón 3750 ml</td>
                <td><input type="number" id="galonCant" min="0" step="1" value="0" class="a33-num" data-a33-default="0" inputmode="numeric"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>Totales y pagos</h3>
        <div class="form-grid">
          <div class="field">
            <label for="envio">Envío (C$)</label>
            <input type="number" id="envio" name="envio" min="0" step="0.01" value="0" class="a33-num" data-a33-default="0" inputmode="decimal">
          </div>
          <div class="field">
            <label for="subtotal">Subtotal (C$)</label>
            <input type="number" id="subtotal" name="subtotal" readonly />
          </div>
          <div class="field">
            <label for="descuento">Descuento (C$)</label>
            <input type="number" id="descuento" name="descuento" min="0" step="0.01" value="0" class="a33-num" data-a33-default="0" inputmode="decimal">
          </div>
          <div class="field">
            <label for="totalPagar">Total a pagar (C$)</label>
            <input type="number" id="totalPagar" name="totalPagar" readonly />
          </div>
          <div class="field">
            <label for="pagoAnticipado">Pago anticipado (C$)</label>
            <input type="number" id="pagoAnticipado" name="pagoAnticipado" min="0" step="0.01" value="0" class="a33-num" data-a33-default="0" inputmode="decimal">
          </div>
          <div class="field">
            <label for="saldoPendiente">Saldo pendiente (C$)</label>
            <input type="number" id="saldoPendiente" name="saldoPendiente" readonly />
          </div>
        </div>

        <div class="form-grid">
          <div class="field">
            <label for="metodoPago">Método de pago</label>
            <select id="metodoPago" name="metodoPago">
              <option value="efectivo">Efectivo</option>
              <option value="transferencia">Transferencia</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="otro">Otro</option>
            </select>
          </div>

          <div class="field">
            <label for="estado">Estado</label>
            <select id="estado" name="estado">
              <option value="pendiente">Pendiente</option>
              <option value="entregado">Entregado</option>
            </select>
          </div>
        </div>

        <h3>Relación con lotes</h3>
        <div class="form-grid">
          <div class="field">
            <label for="lotesRelacionados">Códigos de lote relacionados</label>
            <input type="text" id="lotesRelacionados" name="lotesRelacionados" placeholder="Ej: A33-2025-12-01-01, A33-2025-12-02-02" />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" id="save-btn">Guardar pedido</button>
          <button type="button" class="btn-secondary" id="reset-btn">Limpiar formulario</button>
          <button type="button" class="btn-danger" id="clear-all-btn">Borrar todos</button>
          <button type="button" class="btn-secondary" id="calc-totals-btn">Calcular totales</button>
        </div>
      </form>
    </section>

    <section class="card table-card">
      <div class="table-header">
        <h2>Pedidos registrados</h2>
        <div class="table-actions">
          <input type="search" id="active-search" class="search-input" placeholder="Buscar (cliente, código, fecha, estado)…" autocomplete="off" />
          <button type="button" class="btn-secondary" id="details-toggle" aria-pressed="false">Detalles</button>
          <button type="button" class="btn-secondary" id="export-btn">Exportar a Excel</button>
          <span class="inline-notice" id="export-status" aria-live="polite"></span>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="pedidos-table">
          <thead>
            <tr>
              <th class="col-date col-hide-ipad">Fecha</th>
              <th>Código</th>
              <th>Cliente</th>
              <th>Entrega</th>
              <th>Total (C$)</th>
              <th>Entregado</th>
              <th class="actions-col">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Filas dinámicas -->
          </tbody>
        </table>
      </div>

      <div class="table-pager" id="active-pager" hidden>
        <span class="inline-notice" id="active-count" aria-live="polite"></span>
        <button type="button" class="btn-secondary" id="active-load-more">Cargar más</button>
      </div>
    </section>
  
    <section class="card table-card" id="archived-section">
      <div class="table-header">
        <h2>Histórico <span class="badge" id="archived-count">0</span></h2>
        <div class="table-actions">
          <input type="search" id="archived-search" class="search-input" placeholder="Buscar (cliente, código, fecha, estado)…" autocomplete="off" />
          <button type="button" class="btn-secondary" id="archived-details-toggle" aria-pressed="false">Detalles</button>
          <span class="inline-notice" id="archived-notice" aria-live="polite"></span>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="archived-table">
          <thead>
            <tr>
              <th class="col-date col-hide-ipad">Archivado</th>
              <th class="col-code">Código</th>
              <th>Cliente</th>
              <th class="col-date">Entrega</th>
              <th class="col-status">Estado</th>
              <th class="col-money">Total (C$)</th>
              <th class="actions-col">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="table-pager" id="archived-pager" hidden>
        <span class="inline-notice" id="archived-shown" aria-live="polite"></span>
        <button type="button" class="btn-secondary" id="archived-load-more">Cargar más</button>
      </div>
    </section>

  </main>

  <footer class="app-footer">
    <p>Arcano 33 · Planificación interna de pedidos y entregas</p>
  </footer>

  <script src="./vendor/xlsx.full.min.js?v=4.20.77&r=1"></script>
  <script src="/assets/js/a33-release.js?v=4.20.77&r=1"></script>

  <script src="/assets/js/a33-storage.js?v=4.20.77&r=1"></script>
  <script src="/assets/js/a33-presentations.js?v=4.20.77&r=1"></script>
  <script src="/assets/js/a33-auth.js?v=4.20.77&r=1"></script>
    <script>
    (async () => {
      // Guard robusto (mala señal / offline): evita loops por login.
      try{
        if (!window.A33Auth) return;

        // Migraciones suaves de auth (si aplica)
        if (typeof A33Auth.ensureMigrated === 'function'){
          try{ await A33Auth.ensureMigrated(); }catch(_){ }
        }

        const authed = (typeof A33Auth.isConfigured === 'function' && typeof A33Auth.isAuthenticated === 'function')
          ? (A33Auth.isConfigured() && A33Auth.isAuthenticated())
          : false;

        if (authed) return;

        const looksOffline = async () => {
          try{
            if (typeof navigator !== 'undefined' && navigator.onLine === false) return true;

            // En “mala señal”, navigator.onLine puede mentir. Probamos un HEAD con timeout.
            const ctrl = ('AbortController' in window) ? new AbortController() : null;
            const t = ctrl ? setTimeout(() => { try{ ctrl.abort(); }catch(_){ } }, 2500) : null;

            await fetch('../index.html', {
              method: 'HEAD',
              cache: 'no-store',
              signal: ctrl ? ctrl.signal : undefined
            });

            if (t) clearTimeout(t);
            return false;
          }catch(_){
            return true;
          }
        };

        if (await looksOffline()){
          // Pantalla offline dentro del módulo (no redirección al menú).
          try{ location.replace('./offline.html?reason=auth'); }catch(_){ }
          return;
        }

        // Online: exigir auth (redirige al Home si no hay sesión)
        if (typeof A33Auth.requireAuth === 'function'){
          await A33Auth.requireAuth({ redirectTo: '../index.html' });
        }else{
          location.href = '../index.html';
        }
      }catch(_){ }
    })();
  </script>
  <script src="script.js?v=4.20.77&r=1"></script>
  <script src="/assets/js/a33-input-ux.js?v=4.20.77&r=1"></script>
</body>
</html>
